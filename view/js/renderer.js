(()=>{var or=Object.create;var Ei=Object.defineProperty;var ar=Object.getOwnPropertyDescriptor;var lr=Object.getOwnPropertyNames;var dr=Object.getPrototypeOf,cr=Object.prototype.hasOwnProperty;var ur=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports);var hr=(a,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of lr(t))!cr.call(a,i)&&i!==e&&Ei(a,i,{get:()=>t[i],enumerable:!(r=ar(t,i))||r.enumerable});return a};var mr=(a,t,e)=>(e=a!=null?or(dr(a)):{},hr(t||!a||!a.__esModule?Ei(e,"default",{value:a,enumerable:!0}):e,a));var Ti=(a,t,e)=>{if(!t.has(a))throw TypeError("Cannot "+e)};var n=(a,t,e)=>(Ti(a,t,"read from private field"),e?e.call(a):t.get(a)),m=(a,t,e)=>{if(t.has(a))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(a):t.set(a,e)},p=(a,t,e,r)=>(Ti(a,t,"write to private field"),r?r.call(a,e):t.set(a,e),e);var Oi=ur((Hn,Gt)=>{"use strict";var gr=Object.prototype.hasOwnProperty,O="~";function Ke(){}Object.create&&(Ke.prototype=Object.create(null),new Ke().__proto__||(O=!1));function br(a,t,e){this.fn=a,this.context=t,this.once=e||!1}function Hi(a,t,e,r,i){if(typeof e!="function")throw new TypeError("The listener must be a function");var s=new br(e,r||a,i),o=O?O+t:t;return a._events[o]?a._events[o].fn?a._events[o]=[a._events[o],s]:a._events[o].push(s):(a._events[o]=s,a._eventsCount++),a}function vt(a,t){--a._eventsCount===0?a._events=new Ke:delete a._events[t]}function A(){this._events=new Ke,this._eventsCount=0}A.prototype.eventNames=function(){var t=[],e,r;if(this._eventsCount===0)return t;for(r in e=this._events)gr.call(e,r)&&t.push(O?r.slice(1):r);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t};A.prototype.listeners=function(t){var e=O?O+t:t,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,s=r.length,o=new Array(s);i<s;i++)o[i]=r[i].fn;return o};A.prototype.listenerCount=function(t){var e=O?O+t:t,r=this._events[e];return r?r.fn?1:r.length:0};A.prototype.emit=function(t,e,r,i,s,o){var d=O?O+t:t;if(!this._events[d])return!1;var l=this._events[d],u=arguments.length,f,h;if(l.fn){switch(l.once&&this.removeListener(t,l.fn,void 0,!0),u){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,e),!0;case 3:return l.fn.call(l.context,e,r),!0;case 4:return l.fn.call(l.context,e,r,i),!0;case 5:return l.fn.call(l.context,e,r,i,s),!0;case 6:return l.fn.call(l.context,e,r,i,s,o),!0}for(h=1,f=new Array(u-1);h<u;h++)f[h-1]=arguments[h];l.fn.apply(l.context,f)}else{var g=l.length,y;for(h=0;h<g;h++)switch(l[h].once&&this.removeListener(t,l[h].fn,void 0,!0),u){case 1:l[h].fn.call(l[h].context);break;case 2:l[h].fn.call(l[h].context,e);break;case 3:l[h].fn.call(l[h].context,e,r);break;case 4:l[h].fn.call(l[h].context,e,r,i);break;default:if(!f)for(y=1,f=new Array(u-1);y<u;y++)f[y-1]=arguments[y];l[h].fn.apply(l[h].context,f)}}return!0};A.prototype.on=function(t,e,r){return Hi(this,t,e,r,!1)};A.prototype.once=function(t,e,r){return Hi(this,t,e,r,!0)};A.prototype.removeListener=function(t,e,r,i){var s=O?O+t:t;if(!this._events[s])return this;if(!e)return vt(this,s),this;var o=this._events[s];if(o.fn)o.fn===e&&(!i||o.once)&&(!r||o.context===r)&&vt(this,s);else{for(var d=0,l=[],u=o.length;d<u;d++)(o[d].fn!==e||i&&!o[d].once||r&&o[d].context!==r)&&l.push(o[d]);l.length?this._events[s]=l.length===1?l[0]:l:vt(this,s)}return this};A.prototype.removeAllListeners=function(t){var e;return t?(e=O?O+t:t,this._events[e]&&vt(this,e)):(this._events=new Ke,this._eventsCount=0),this};A.prototype.off=A.prototype.removeListener;A.prototype.addListener=A.prototype.on;A.prefixed=O;A.EventEmitter=A;typeof Gt<"u"&&(Gt.exports=A)});var pr=a=>{let t=[],e={},r=[],i="div";return a.replace(/(?!<\\)(["']).+?(?!<\\)(\1)/g,o=>"string$"+(r.push(o.slice(1,-1))-1)).split(/(?=[.#[])/).forEach(o=>{var d;if(!o.match(/^[.#\[]/)){i=o;return}if(o[0]==="."){t.push(o.slice(1));return}if(o[0]==="#"){e.id=o[0].slice(1);return}if(o[0]==="["){let l=o.match(/\[([^=]+)(=(["']?)(.+?)\3)?]/);l!==null&&(e[l[1]]=((d=l[4])!=null?d:"").replace(/string\$(\d+)/,(u,f)=>r[f]));return}}),[i,t,e]},v=a=>document.createTextNode(a),c=(a,...t)=>{let[e,r,i]=pr(a),s=document.createElement(e);return r.length&&s.classList.add(...r),fr(s,i),t.length&&s.append(...t),s},fr=(a,t)=>(Object.entries(t).forEach(([e,r])=>a.setAttribute(e,r)),a),I=(a,t)=>(Object.entries(t).forEach(([e,r])=>a.addEventListener(e,r)),a);var lt=({hierarchy:a,objects:t},e=null)=>{let r=new Map;e&&Object.keys(t).forEach(s=>e.push(s));let i=s=>{if(r.has(s))return r.get(s);if(Array.isArray(s)){let o=[];return r.set(s,o),s.forEach(d=>o.push(i(d))),o}if(s&&s["#ref"]){if(e&&e.splice(e.indexOf(s["#ref"]),1),!(s["#ref"]in t))throw new TypeError(`missing ${s["#ref"]}`);let o=i(t[s["#ref"]]);return r.set(s,o),o}if(s instanceof Object){let o={};return r.set(s,o),Object.entries(s).forEach(([d,l])=>{o[d]=i(l)}),o}return s};return i(a)};var ue,he=class{constructor(t=c("div")){m(this,ue,void 0);p(this,ue,t)}build(...t){}element(){return n(this,ue)}empty(){for(;n(this,ue).firstChild!==null;)n(this,ue).firstChild.remove()}};ue=new WeakMap;var Y=he;var ze,me,Pt=class{constructor(t){m(this,ze,void 0);m(this,me,void 0);p(this,ze,t),p(this,me,c("div.action")),n(this,me).addEventListener("keydown",e=>{e.key!=="Escape"&&e.stopPropagation()}),this.build()}activate(){}build(){}complete(){let t=new CustomEvent("actioned",{bubbles:!0,detail:this});n(this,me).dispatchEvent(t)}element(){return n(this,me)}value(){return n(this,ze).value}};ze=new WeakMap,me=new WeakMap;var q=Pt;var vr=(a,t)=>c("fieldset",c("legend",v(a)),c(`input[type="range"][max="100"][min="0"][step="1"][value="${t}"]`),c('input[type="number"]'),c("label",c('input[type="checkbox"]'),v("Lock"))),De,$,F,Ee,Re,St=class extends Y{constructor(e,r){super(vr(e,r));m(this,De,void 0);m(this,$,void 0);m(this,F,void 0);m(this,Ee,void 0);m(this,Re,[]);p(this,De,e),p(this,$,this.element().querySelector('input[type="range"]')),p(this,F,this.element().querySelector('input[type="number"]')),p(this,Ee,this.element().querySelector('input[type="checkbox"]')),this.build()}build(){this.set(n(this,$).value),n(this,$).addEventListener("input",()=>this.set(n(this,$).value)),n(this,F).addEventListener("input",()=>this.set(n(this,F).value)),n(this,Ee).addEventListener("input",()=>this.lock()),this.lock()}label(){return n(this,De)}lock(){if(this.isLocked()){n(this,$).setAttribute("disabled",""),n(this,F).setAttribute("disabled","");return}n(this,$).removeAttribute("disabled"),n(this,F).removeAttribute("disabled")}onInput(e){n(this,Re).push(e)}isLocked(){return n(this,Ee).checked}set(e){e=Math.max(parseInt(e,10),0).toString(),n(this,$).value!==e&&(n(this,$).value=e),n(this,F).value!==e&&(n(this,F).value=e),n(this,Re).forEach(r=>r())}value(){return parseInt(n(this,$).value,10)}};De=new WeakMap,$=new WeakMap,F=new WeakMap,Ee=new WeakMap,Re=new WeakMap;var Li=St;var te,kt=class{constructor(...t){m(this,te,void 0);p(this,te,t),n(this,te).forEach(e=>e.onInput(()=>{if(this.total()===100)return;let r=n(this,te).filter(s=>s!==e),i=r.filter(s=>!s.isLocked());if(this.total()!==100&&i.length===0){e.set((100-this.total(r)).toString());return}if(this.total()>100){let s=this.total()-100,o=Math.ceil(s/i.length);i.forEach(d=>{d.set((d.value()-Math.min(o,s)).toString()),s-=o}),this.total()>100&&e.set((100-this.total(r)).toString())}if(this.total()<100){let s=100-this.total(),o=Math.ceil(s/i.length);i.forEach(d=>{d.set((d.value()+Math.min(o,s)).toString()),s-=o}),this.total()<100&&e.set((100-this.total(r)).toString())}}))}sliders(){return n(this,te)}total(t=n(this,te)){return t.reduce((e,r)=>e+r.value(),0)}};te=new WeakMap;var Ci=kt;var Te,At=class extends he{constructor(e,r=c("div")){super(r);m(this,Te,void 0);this.element().addEventListener("keydown",i=>{i.stopPropagation()}),this.element().setAttribute("tabindex","0"),p(this,Te,e)}display(){this.build(),n(this,Te).append(this.element())}parent(){return n(this,Te)}};Te=new WeakMap;var Ii=At;var Mi={autoDisplay:!0,canClose:!0,canMaximise:!1,canResize:!1,parent:document.body,position:"auto",size:"auto"},pe,Ne,$e=class extends Ii{constructor(e,r,i={}){var s;super((s=i.parent)!=null?s:Mi.parent,c("div.window"));m(this,pe,void 0);m(this,Ne,void 0);this.options={...Mi,...i},p(this,pe,r),p(this,Ne,e),this.options.size==="auto"&&this.element().classList.add("size-auto"),this.options.size==="maximised"&&this.element().classList.add("maximised"),this.options.size!=="auto"&&["height","width"].forEach(o=>{let d=this.options.size[o];if(typeof d=="number"){this.element().style[o]=d+"px";return}this.element().style[o]=d}),this.options.position==="auto"&&this.element().classList.add("position-auto"),this.options.position!=="auto"&&[["x","left"],["y","top"]].forEach(([o,d])=>{this.element().style[d]=Math.min(0,Math.max(document.body.clientHeight-20,this.options.position[o]))+"px"}),this.options.autoDisplay&&this.display()}build(){this.empty();let e=[[this.options.canMaximise,I(c('button.maximise[aria-label="Maximise"]',v("Maximise"),c('img.maximise[src="../../node_modules/feather-icons/dist/icons/maximize.svg"][alt="Maximise"]'),c('img.restore[src="../../node_modules/feather-icons/dist/icons/minimize.svg"][alt="Restore"]')),{click:()=>this.maximise()})],[this.options.canClose,I(c('button.close[aria-label="Close"]',v("Close"),c('img[src="../../node_modules/feather-icons/dist/icons/x.svg"][alt="Close"]')),{click:()=>this.close()})]].filter(([r])=>r).map(([,r])=>r);this.element().append(I(c("header",c("h3",v(n(this,Ne))),...e),{dblclick:()=>this.maximise()}),c("div.body",n(this,pe)instanceof Node?n(this,pe):c("p",v(n(this,pe))))),this.element().addEventListener("keydown",r=>{r.key==="Escape"&&this.options.canClose&&this.close(),r.stopPropagation()})}close(){this.element().remove(),this.element().dispatchEvent(new CustomEvent("close"))}display(e=!0){super.display(),e&&this.element().focus()}maximise(){!this.options.canMaximise||this.element().classList.toggle("maximised")}update(e){this.element().lastElementChild.remove(),this.element().append(e instanceof Node?e:c("p",v(e)))}};pe=new WeakMap,Ne=new WeakMap;var dt=$e;var Ue,_t=class extends q{constructor(){super(...arguments);m(this,Ue,void 0)}activate(){let e=[];new dt("Adjust trade rates",c("div",...this.value().all.map(i=>{let s=new Li(i._,i.value*100);return e.push(s),s.element()}))).element().addEventListener("close",()=>{transport.send("action",{name:"AdjustTradeRates",id:this.value().id,value:n(this,Ue).sliders().map(i=>[i.label(),parseFloat((i.value()/100).toFixed(2))])})}),p(this,Ue,new Ci(...e))}build(){this.element().append(c('button.adjustTradeRates[title="Adjust trade rates"]'))}value(){return super.value()}};Ue=new WeakMap;var Pi=_t;var Ht=[],je,ct=class extends $e{constructor(e,r,i={}){let s={queue:!0,...i};super(e,r,s);m(this,je,{});p(this,je,s),this.element().classList.add("notificationWindow"),this.element().addEventListener("keydown",o=>{o.key==="Enter"&&(this.close(),o.stopPropagation())})}close(){if(super.close(),n(this,je).queue&&Ht.length&&ct.hasOpenWindow()){let[e,r,i]=Ht.shift();e.display(r),i()}}display(e=!0){return new Promise(r=>{if(ct.hasOpenWindow()){Ht.push([this,e,r]);return}if(super.display(),!e){r(void 0);return}this.element().focus(),r(void 0)})}static hasOpenWindow(){return!!document.querySelector("div.notificationWindow")}},fe=ct;je=new WeakMap;var ut=fe;var Be,Ge,ve=class extends fe{constructor(e,r,i,s="Please choose one of the following:",o={}){o={autoFocus:!0,displayAll:!1,...o,actions:{primary:{label:"OK",action:u=>d(u.selectionList().value)},...o.actions}};let d=u=>{this.element().dispatchEvent(new CustomEvent("selection",{detail:u})),this.close(),i(u)},l=I(c("select",...r.map(u=>c(`option[value="${u.value}"]`,v(u.label||u.value)))),{keydown:u=>{u.key==="Enter"&&d(l.value)},dblclick:()=>d(l.value)});o.displayAll&&r.length>1&&l.setAttribute("size",r.length.toString()),o.autoFocus&&l.setAttribute("autofocus","");super(e,c("div",...s instanceof Node?[s]:s===null?[]:[c("p",v(s))],l,c("footer",...Object.entries(o.actions).map(([,{label:u,action:f}])=>I(c("button",v(u)),{click:()=>f(this),keydown:h=>{h.key==="Enter"&&f(this)}})))));m(this,Be,()=>this.resize());m(this,Ge,void 0);this.element().classList.add("selectionWindow"),p(this,Ge,l),this.resize(),window.addEventListener("resize",n(this,Be))}close(){window.removeEventListener("resize",n(this,Be)),super.close()}display(){return super.display(!1).then(()=>{let e=this.element().querySelector("select");e&&e.hasAttribute("autofocus")&&e.focus()})}resize(){var e,r;try{this.selectionList().style.maxHeight="none",this.selectionList().style.maxHeight=`calc(${this.element().offsetHeight-3-this.element().firstElementChild.offsetHeight-((r=(e=this.selectionList().previousElementSibling)==null?void 0:e.offsetHeight)!=null?r:0)-this.selectionList().nextElementSibling.offsetHeight}px - 2em)`}catch(i){console.warn(i)}}selectionList(){return n(this,Ge)}};Be=new WeakMap,Ge=new WeakMap;var ie=ve;var Ot=class extends q{activate(){let t=new ie("Choose research",this.value().available.map(e=>({value:e._})),e=>{!e||(transport.send("action",{name:"ChooseResearch",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which advance would you like to research next?",{displayAll:!0})}build(){this.element().append(c('button.chooseResearch[title="Choose research"]'))}value(){return super.value()}},Si=Ot;var re,ge,Xe,Ve,ne,Ye,se,B=class{constructor(t,e=2,r=16,i=c("canvas")){m(this,re,void 0);m(this,ge,void 0);m(this,Xe,!0);m(this,Ve,void 0);m(this,ne,void 0);m(this,Ye,void 0);m(this,se,void 0);p(this,re,i),p(this,se,t),p(this,Ye,r),p(this,ne,e),this.setCanvasSize(),p(this,ge,n(this,re).getContext("2d")),p(this,Ve,document.querySelector("#preload"))}canvas(){return n(this,re)}clear(){this.context().clearRect(0,0,this.canvas().width,this.canvas().height)}context(){return n(this,ge)}render(t=this.world().tiles()){this.clear(),t.forEach(({x:e,y:r})=>this.renderTile(this.world().get(e,r)))}renderTile({x:t,y:e}){let r=this.tileSize(),i=t*r,s=e*r;this.context().clearRect(i,s,r,r)}scale(){return n(this,ne)}tileSize(){return n(this,Ye)*n(this,ne)}update(t){t.forEach(({x:e,y:r})=>this.renderTile(this.world().get(e,r)))}world(){return n(this,se)}drawImage(t,e,r,i={}){var u,f;let s=this.tileSize(),o=e*s,d=r*s,l=this.getPreloadedImage(t);this.putImage(i.augment?i.augment(l):l,o+((u=i.offsetX)!=null?u:0),d+((f=i.offsetY)!=null?f:0))}filterNeighbours(t,e,r=["n","e","s","w"]){return r.filter(i=>e(n(this,se).getNeighbour(t,i)))}getPreloadedImage(t){let e=n(this,Ve).querySelector(`[src$="${t}.png"]`);return e===null?(console.error(`Missing image: ${t}.`),c("canvas")):e}putImage(t,e,r){n(this,ge).imageSmoothingEnabled=!1,n(this,ge).drawImage(t,e,r,t.width*n(this,ne),t.height*n(this,ne))}replaceColors(t,e,r){let i=c("canvas"),s=i.getContext("2d");i.width=t.width,i.height=t.height,s.drawImage(t,0,0,t.width,t.height);let o=s.getImageData(0,0,i.width,i.height),d=f=>{var y;let h=null,g={r:0,g:0,b:0,a:0};return typeof f=="string"?(h=f.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i))!==null?g={r:parseInt(h[1],16),g:parseInt(h[2],16),b:parseInt(h[3],16),a:1}:(h=f.match(/^#([0-9a-fA-F])([0-9a-fA-F])([0-9a-fA-F])$/))!==null?g={r:parseInt(h[1]+h[1],16),g:parseInt(h[2]+h[2],16),b:parseInt(h[3]+h[3],16),a:1}:(h=f.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/))!==null?g={r:parseInt(h[1]),g:parseInt(h[2]),b:parseInt(h[3]),a:1}:(h=f.match(/^rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+|\d+\.|\.\d+|\d+\.\d+)\s*\)\s*$/))!==null&&(g={r:parseInt(h[1]),g:parseInt(h[2]),b:parseInt(h[3]),a:parseFloat((y=h[4])!=null?y:1)}):"length"in f&&(g={r:f[0]||0,g:f[1]||0,b:f[2]||0,a:f[3]||1}),g},l=e.map(d),u=r.map(d);for(let f=0;f<o.data.length;f+=4)l.forEach((h,g)=>{o.data[f]===h.r&&o.data[f+1]===h.g&&o.data[f+2]===h.b&&o.data[f+3]===h.a*255&&(o.data[f]=(u[g]||u[0]).r,o.data[f+1]=(u[g]||u[0]).g,o.data[f+2]=(u[g]||u[0]).b,o.data[f+3]=Math.trunc((u[g]||u[0]).a*255))});return s.putImageData(o,0,0),i}setCanvasSize(){n(this,re).height=n(this,se).height()*this.tileSize(),n(this,re).width=n(this,se).width()*this.tileSize()}isVisible(){return n(this,Xe)}setVisible(t){p(this,Xe,t)}};re=new WeakMap,ge=new WeakMap,Xe=new WeakMap,Ve=new WeakMap,ne=new WeakMap,Ye=new WeakMap,se=new WeakMap;var ki=B;var Wt=class extends B{renderTile(t){super.renderTile(t);let{x:e,y:r}=t,i=this.tileSize(),s=e*i,o=r*i;if(t.city){let d=t.city,l=d.player,u=l.civilization,[f]=u.attributes.filter(h=>h.name==="colors");t.units.length>0&&(this.context().fillStyle="#000",this.context().fillRect(s,o,i,i)),this.context().fillStyle=f.value[0],this.context().fillRect(s+this.scale(),o+this.scale(),i-this.scale()*2,i-this.scale()*2),this.drawImage("map/city",e,r,{augment:h=>this.replaceColors(h,["#000"],[f.value[1]]),offsetX:this.scale(),offsetY:this.scale()})}}},qe=Wt;var zt=class extends fe{constructor(t,e,r,i={}){var o,d;let s=I(c("button",v((o=i.okLabel)!=null?o:"OK")),{click:()=>{r(),this.close()},keydown:l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),l.stopPropagation(),r(),this.close())}});super(t,c("div.content",c("p",v(e)),c("footer",s,I(c("button",v((d=i.cancelLabel)!=null?d:"Cancel")),{click:()=>this.close(),keydown:l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),l.stopPropagation(),this.close())}}))),{...i,queue:!1}),s.focus()}},Ai=zt;var Le,Ce,Dt=class{constructor(t,e){m(this,Le,void 0);m(this,Ce,[]);this.setIds(t),p(this,Le,r=>{let{detail:i}=r,s=i.value.objects;!s||n(this,Ce).some(o=>o in s)&&document.addEventListener("dataupdated",o=>e(o.detail.data),{once:!0})}),document.addEventListener("patchdatareceived",n(this,Le))}dispose(){document.removeEventListener("patchdatareceived",n(this,Le))}setIds(t){n(this,Ce).splice(0,n(this,Ce).length,...t)}};Le=new WeakMap,Ce=new WeakMap;var _i=Dt;var Rt=class extends B{update(t){let e=[...t];return t.forEach(r=>{["n","ne","e","se","s","sw","w","nw"].forEach(i=>{let s=this.world().getNeighbour(r,i);e.includes(s)||e.push(s)})}),super.update(e)}},D=Rt;var $t=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:r}=t;t.terrain.features.length&&t.terrain.features.forEach(i=>i._==="Shield"?this.drawImage(`terrain/${i._.toLowerCase()}`,e,r,{offsetX:4*this.scale(),offsetY:4*this.scale()}):this.drawImage(`terrain/${i._.toLowerCase()}`,e,r))}},ht=$t;var Nt=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:r}=t;this.filterNeighbours(t,i=>i.terrain._==="Unknown").forEach(i=>this.drawImage(`map/fog_${i}`,e,r))}},mt=Nt;var Ut=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:r}=t,i=t.improvements.reduce((s,o)=>{let d=o._;return d in s&&(s[d]=!0),s},{Mine:!1,Road:!1,Railroad:!1,Pollution:!1});if(["Mine","Pollution"].forEach(s=>{i[s]&&this.drawImage(`improvements/${s.toLowerCase()}`,e,r)}),i.Road){let s=this.filterNeighbours(t,d=>d.improvements.some(l=>l._==="Road"),["n","ne","e","se","s","sw","w","nw"]),o=this.filterNeighbours(t,d=>!!d.city||d.improvements.some(l=>l._==="Railroad"),["n","ne","e","se","s","sw","w","nw"]);if(s.forEach(d=>{(!i.Railroad||!o.includes(d))&&this.drawImage(`improvements/road_${d}`,e,r)}),i.Railroad&&o.forEach(d=>this.drawImage(`improvements/railroad_${d}`,e,r)),s.length===0&&o.length===0){let d=this.tileSize(),l=e*d,u=r*d,f=Math.floor(this.tileSize()/2)-this.scale();this.context().fillStyle=i.Railroad?"#000":"#8c5828",this.context().rect(l+f,u+f,this.scale()*2,this.scale()*2),this.context().fill()}}}},pt=Ut;var jt=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:r}=t;!t.improvements.some(s=>s._==="Irrigation")||this.drawImage("improvements/irrigation",e,r)}},ft=jt;var Bt=class extends D{renderTile(t){super.renderTile(t);let{x:e,y:r}=t,i=this.tileSize(),s=e*i,o=r*i;if(t.terrain._!=="Unknown"){if(t.isLand)this.drawImage("terrain/land",e,r);else if(t.isWater&&(this.drawImage("terrain/ocean",e,r),t.isCoast)){let d=this.getPreloadedImage("terrain/coast_sprite"),l=(this.world().getNeighbour(t,"w").isLand?1:0)|(this.world().getNeighbour(t,"nw").isLand?2:0)|(this.world().getNeighbour(t,"n").isLand?4:0)|(this.world().getNeighbour(t,"ne").isLand?8:0)|(this.world().getNeighbour(t,"e").isLand?16:0)|(this.world().getNeighbour(t,"se").isLand?32:0)|(this.world().getNeighbour(t,"s").isLand?64:0)|(this.world().getNeighbour(t,"sw").isLand?128:0);if(l>0){let u=l&7,f=l>>2&7,h=l>>4&7,g=l>>6&7|(l&1)<<2,y=c('canvas[height="16"][width="16"]'),M=y.getContext("2d");M.drawImage(d,u<<4,0,8,8,0,0,8,8),M.drawImage(d,(f<<4)+8,0,8,8,8,0,8,8),M.drawImage(d,(h<<4)+8,8,8,8,8,8,8,8),M.drawImage(d,g<<4,8,8,8,0,8,8,8),this.putImage(y,s,o)}this.filterNeighbours(t,u=>u.terrain._==="River").forEach(u=>this.drawImage(`terrain/river_mouth_${u}`,e,r))}}}},Fe=Bt;var Wi=mr(Oi());var yr={playerId:null,scale:2,tileSize:16},R,_,be,N,Qe,Q,Je,H,Xt=class extends Wi.EventEmitter{constructor(e,r=c("canvas"),i={playerId:null,scale:2},...s){let o={...yr,...i};super();m(this,R,void 0);m(this,_,{x:0,y:0});m(this,be,void 0);m(this,N,[]);m(this,Qe,null);m(this,Q,void 0);m(this,Je,void 0);m(this,H,void 0);p(this,H,e),p(this,R,r),p(this,Qe,o.playerId),p(this,Je,o.tileSize),p(this,Q,o.scale),s.forEach(d=>n(this,N).push(new d(n(this,H),this.scale(),this.tileSize()))),p(this,be,r.getContext("2d")),this.bindEvents()}bindEvents(){}build(e){n(this,N).forEach(r=>r.update(e))}canvas(){return n(this,R)}center(){return n(this,_)}getLayer(e){var r;return(r=this.getLayers(e).shift())!=null?r:null}getLayers(e){return n(this,N).filter(r=>r instanceof e)}isVisible(e,r){let[i,s,o,d]=this.visibleBounds();return(i>s?e<s||e>i:e<s&&e>i)&&(o>d?r<d||r>o:r<d&&r>o)}playerId(){return n(this,Qe)}render(){let e=n(this,N)[0].tileSize(),r=n(this,H).width()*e,i=n(this,_).x*e+Math.trunc(e/this.scale()),s=Math.trunc(n(this,R).width/2),o=n(this,H).height()*e,d=n(this,_).y*e+Math.trunc(e/this.scale()),l=Math.trunc(n(this,R).height/2),u=s-i,f=s+r,h=l-d,g=l+o;for(;u>0;)u-=r;for(;h>0;)h-=o;for(;f<n(this,R).width;)f+=r;for(;g<n(this,R).height;)g+=o;n(this,be).fillStyle="#000",n(this,be).fillRect(0,0,n(this,H).width()*e,n(this,H).height()*e);for(let y=u;y<f;y+=r)for(let M=h;M<g;M+=o)n(this,N).forEach(X=>{if(!X.isVisible())return;let P=X.canvas();n(this,be).drawImage(P,y,M,P.width,P.height)})}scale(){return n(this,Q)}setCenter(e,r){n(this,_).x=e,n(this,_).y=r,this.render(),this.emit("focus-changed",e,r)}tileSize(){return n(this,Je)}visibleBounds(){let e=Math.floor(n(this,R).width/n(this,N)[0].tileSize()/n(this,Q)),r=Math.floor(n(this,R).height/n(this,N)[0].tileSize()/n(this,Q)),i=(n(this,_).x-e+n(this,H).width())%n(this,H).width(),s=(n(this,_).x+e)%n(this,H).width(),o=(n(this,_).y-r+n(this,H).height())%n(this,H).height(),d=(n(this,_).y+r)%n(this,H).height();return[i,s,o,d]}visibleRange(){let e=Math.floor(n(this,R).width/n(this,N)[0].tileSize()/n(this,Q)),r=Math.floor(n(this,R).height/n(this,N)[0].tileSize()/n(this,Q));return[{x:n(this,_).x-e,y:n(this,_).y-r},{x:n(this,_).x+e,y:n(this,_).y+r}]}world(){return n(this,H)}};R=new WeakMap,_=new WeakMap,be=new WeakMap,N=new WeakMap,Qe=new WeakMap,Q=new WeakMap,Je=new WeakMap,H=new WeakMap;var gt=Xt;var Vt=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:r}=t,i=this.filterNeighbours(t,s=>t.terrain._==="River"&&s.isWater||t.terrain._===s.terrain._).join("");t.terrain._!=="Ocean"&&(i?this.drawImage(`terrain/${t.terrain._.toLowerCase()}_${i}`,e,r):this.drawImage(`terrain/${t.terrain._.toLowerCase()}`,e,r))}},bt=Vt;var yt,Ie,oe,ae,le,Yt=class{constructor(t){m(this,yt,(t,e)=>({_:"Tile",id:`Tile-${t}--${e}`,city:null,goodyHut:null,improvements:[],isCoast:!1,isLand:!1,isWater:!1,terrain:{_:"Unknown",id:`UnknownTerrain-${t}--${e}`,features:[]},units:[],x:t,y:e,yields:[]}));m(this,Ie,{});m(this,oe,void 0);m(this,ae,void 0);m(this,le,void 0);p(this,ae,t.height),p(this,le,t.width),p(this,oe,t.tiles||[])}get(t,e){for(;t<0;)t+=n(this,le);for(;e<0;)e+=n(this,ae);for(;t>=n(this,le);)t-=n(this,le);for(;e>=n(this,ae);)e-=n(this,ae);let r=[t,e].toString();if(!(r in n(this,Ie))){let i=n(this,oe).findIndex(s=>s.x===t&&s.y===e);if(i===-1)return n(this,yt).call(this,t,e);n(this,Ie)[r]=i}return n(this,oe)[n(this,Ie)[r]]}getNeighbour(t,e){if(e==="n")return this.get(t.x,t.y-1);if(e==="ne")return this.get(t.x+1,t.y-1);if(e==="e")return this.get(t.x+1,t.y);if(e==="se")return this.get(t.x+1,t.y+1);if(e==="s")return this.get(t.x,t.y+1);if(e==="sw")return this.get(t.x-1,t.y+1);if(e==="w")return this.get(t.x-1,t.y);if(e==="nw")return this.get(t.x-1,t.y-1);throw new TypeError("Invalid direction.")}height(){return n(this,ae)}tiles(){return n(this,oe)}width(){return n(this,le)}setTiles(t){p(this,oe,t)}};yt=new WeakMap,Ie=new WeakMap,oe=new WeakMap,ae=new WeakMap,le=new WeakMap;var wt=Yt;var qt=class extends ki{renderTile(t){super.renderTile(t);let{x:e,y:r}=t,i=this.tileSize(),s=e*i,o=r*i,d=t.yields.reduce((h,g)=>h+g.value,0),l=t.yields.sort((h,g)=>h._.charCodeAt(0)-g._.charCodeAt(0)),u=0;if(d<5){let h=[[s,o],[s+i/2,o],[s,o+i/2],[s+i/2,o+i/2]];l.forEach(g=>{for(let y=0;y<g.value;y++)this.putImage(this.getPreloadedImage(`city/${g._.toLowerCase()}`),...h[u++])});return}if(d<7){let h=[[s,o],[s+i/3,o],[s+i/3*2,o],[s,o+i/2],[s+i/3,o+i/2],[s+i/3*2,o+i/2]];l.forEach(g=>{for(let y=0;y<g.value;y++)this.putImage(this.getPreloadedImage(`city/${g._.toLowerCase()}`),h[u][0],h[u++][1])});return}if(d<9){let h=[[s,o],[s+i/4,o],[s+i/4*2,o],[s+i/4*3,o],[s,o+i/2],[s+i/4,o+i/2],[s+i/4*2,o+i/2],[s+i/4*3,o+i/2]];l.forEach(g=>{for(let y=0;y<g.value;y++)this.putImage(this.getPreloadedImage(`city/${g._.toLowerCase()}`),...h[u++])});return}if(d<11){let h=[[s,o],[s+i/5,o],[s+i/5*2,o],[s+i/5*3,o],[s+i/5*4,o],[s,o+i/2],[s+i/5,o+i/2],[s+i/5*2,o+i/2],[s+i/5*3,o+i/2],[s+i/5*4,o+i/2]];l.forEach(g=>{for(let y=0;y<g.value;y++)this.putImage(this.getPreloadedImage(`city/${g._.toLowerCase()}`),...h[u++])});return}let f=[[s,o],[s+i/6,o],[s+i/6*2,o],[s+i/6*3,o],[s+i/6*4,o],[s+i/6*5,o],[s,o+i/2],[s+i/6,o+i/2],[s+i/6*2,o+i/2],[s+i/6*3,o+i/2],[s+i/6*4,o+i/2],[s+i/6*5,o+i/2]];l.forEach(h=>{for(let g=0;g<h.value;g++)this.putImage(this.getPreloadedImage(`city/${h._.toLowerCase()}`),...f[u++])})}},Me=qt;var zi=a=>Math.max(1,Math.ceil((a.build.cost.value-a.build.progress.value)/a.yields.filter(t=>t._==="Production").reduce((t,e)=>t+e.value,0))),wr=(a,t,e)=>c("div.build",c("header",v(`Building ${a.build.building?a.build.building.item._:"nothing"}`)),a.build.building?c("p",v(`Progress ${a.build.progress.value} / ${a.build.cost.value} (${zi(a)} turn${zi(a)===1?"":"s"})`)):v(""),I(c("button",v(a.build.building?"Change":"Choose")),{click:()=>t()}),I(c("button",v("Buy")),{click:()=>e()})),Di=(a,t,e,r)=>{let i=c("canvas"),s=a.growth,o=new gt(new wt(a.player.world),i,{playerId:a.player.id,scale:t.scale(),tileSize:t.tileSize()},Fe,ft,bt,pt,ht,mt,qe,Me);return i.height=t.tileSize()*t.scale()*5,i.width=t.tileSize()*t.scale()*5,o.setCenter(a.tile.x,a.tile.y),o.build(a.tiles),o.getLayer(Me).render(a.tilesWorked),o.render(),c("div",c("div.yields-detail",...Object.entries(a.yields.reduce((l,u)=>(u._ in l||(l[u._]=0),l[u._]+=u.value,l),{})).map(([l,u])=>c("div",c("div",v(l)),c("div",v(u))))),I(c("div.cityPortal",i),{click:()=>transport.send("action",{name:"ReassignWorkers",city:a.id})}),wr(a,e,r),c("div.growth",c("header",v(s.size.toString())),c("p",v(`Growth ${s.progress.value} / ${s.cost.value}`))),c("div.improvements",c("header",v("Improvements")),c("ul",...a.improvements.map(l=>c("li",v(l._))))),c("div.garrisoned-units",c("header",v("Garrisoned Units")),c("ul",...a.tile.units.map(l=>c("li",v(l._+(l.improvements.length?" ("+l.improvements.map(u=>u._).join(", ")+")":"")))))),c("div.supported-units",c("header",v("Supported Units")),c("ul",...a.units.map(l=>c("li",v(l._+(l.improvements.length?" ("+l.improvements.map(u=>u._).join(", ")+")":"")))))),c("div.yields-detail",...a.yields.map(l=>c(`div.${l._.toLowerCase()}`,c("div",v(`${l._} (${l.values.map(([,u])=>u).join(", ")})`)),c("div",v(l.value.toString()))))))},J,Pe,Ze,Ft=class extends dt{constructor(e,r){super(e.name,Di(e,r,()=>this.changeProduction(),()=>this.completeProduction()),{size:"maximised"});m(this,J,void 0);m(this,Pe,void 0);m(this,Ze,void 0);p(this,J,e),p(this,Ze,r),p(this,Pe,new _i([e.id,e.build.id,e.growth.id,...e.units.map(i=>i.id)],i=>{var o,d;let[s]=((d=(o=i.player)==null?void 0:o.cities)!=null?d:[]).filter(l=>e.id===l.id);if(!s){this.close();return}p(this,J,s),n(this,Pe).setIds([s.id,s.build.id,s.growth.id,...s.units.map(l=>l.id)]),this.update(Di(s,n(this,Ze),()=>this.changeProduction(),()=>this.completeProduction())),this.element().focus()})),this.element().addEventListener("keydown",i=>{["c","C"].includes(i.key)&&(this.changeProduction(),i.preventDefault(),i.stopPropagation()),["b","B"].includes(i.key)&&(this.completeProduction(),i.preventDefault(),i.stopPropagation()),["Enter","x","X"].includes(i.key)&&this.close()})}changeProduction(){new Se(n(this,J).build,()=>this.element().focus())}close(){n(this,Pe).dispose(),super.close()}completeProduction(){!n(this,J).build.building||new Ai("Are you sure?",`Do you want to rush building of ${n(this,J).build.building.item._}`,()=>transport.send("action",{name:"CompleteProduction",id:n(this,J).id}))}};J=new WeakMap,Pe=new WeakMap,Ze=new WeakMap;var xt=Ft;var et=class extends ve{constructor(e,r=()=>{},i={}){let s=e.city.yields.filter(d=>d._==="Production").reduce((d,l)=>d+l.value,0),o=d=>Math.ceil((d.cost.value-e.progress.value)/s);super(`What would you like to build in ${e.city.name}?`,e.available.map(d=>({label:`${d.item._} (Cost: ${d.cost.value} / ${o(d)} turn${o(d)===1?"":"s"})`,value:d.item._})),d=>{!d||(transport.send("action",{name:e.building===null?"CityBuild":"ChangeProduction",id:e.id,chosen:d||"@"}),this.close(!0))},null,{actions:i,displayAll:!0});this.onComplete=r}close(e=!1){super.close(),e&&this.onComplete(e)}};et.showCityAction=(e,r)=>({label:"View city",action(i){i.close(),new xt(e,r)}}),et.showCityOnMapAction=(e,r)=>({label:"Show on map",action(i){i.close(),r.setCenter(e.tile.x,e.tile.y)}});var Se=et;var ke,Kt=class extends q{constructor(e,r){super(e);m(this,ke,void 0);p(this,ke,r)}activate(){new Se(this.value(),()=>this.complete(),{showCity:Se.showCityAction(this.value().city,n(this,ke)),showCityOnMap:Se.showCityOnMapAction(this.value().city,n(this,ke))})}build(){let e=this.value();this.element().append(c(`button.cityBuild[title="What would you like to build in ${e.city.name}?"]`))}value(){return super.value()}};ke=new WeakMap;var Ri=Kt;var Qt=class extends q{activate(){transport.send("action",{name:"EndTurn"})}build(){this.element().append(c('button.endTurn[title="End turn"]'))}},$i=Qt;var Jt=class extends q{activate(){let t=new ie("Choose government",this.value().available.map(e=>({value:e._})),e=>{!e||(transport.send("action",{name:"Revolution",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which government would you like to convert to?",{displayAll:!0})}build(){this.element().append(c('button.chooseGovernment[title="Choose government"]'))}value(){return super.value()}},Ni=Jt;var tt,Zt=class extends he{constructor(e=c("div.actions"),r){super(e);m(this,tt,void 0);p(this,tt,r),this.element().addEventListener("actioned",i=>i.detail.element().remove()),this.element().addEventListener("keydown",i=>{var f;let s=document.activeElement;if(!this.element().contains(s))return;let{key:o}=i,d=Array.from(this.element().children);if(!["ArrowDown","ArrowLeft","ArrowRight","ArrowUp"].includes(o)||d.length===0)return;i.preventDefault(),i.stopPropagation();let l=s===this.element()?["ArrowLeft","ArrowUp"].includes(o)?s.firstElementChild:s.lastElementChild:s;for(;l.parentElement!==this.element();)l=l.parentElement;let u=d.indexOf(l);if(["ArrowUp","ArrowLeft"].includes(o)){if(u>0){(f=d[u-1].querySelector("button"))==null||f.focus();return}d.pop().querySelector("button").focus();return}if(["ArrowDown","ArrowRight"].includes(o)){if(u<d.length-1){d[u+1].querySelector("button").focus();return}d.shift().querySelector("button").focus();return}},!0)}build(e){this.empty(),e.forEach(r=>{let i;switch(r._){case"ActiveUnit":return;case"AdjustTradeRates":i=new Pi(r);break;case"ChooseResearch":i=new Si(r);break;case"CityBuild":i=new Ri(r,n(this,tt));break;case"EndTurn":i=new $i(r);break;case"Revolution":i=new Ni(r);break;default:console.log("need to handle "+r._);return}this.element().prepend(I(i.element(),{click:()=>i.activate(),keydown:({key:s})=>{(s===" "||s==="Enter")&&i.activate()}}))})}};tt=new WeakMap;var ei=Zt;var xr={BuildingIrrigation:"I",BuildingMine:"M",BuildingRoad:"R",BuildingRailroad:"RR"},ye,ti=class extends B{constructor(){super(...arguments);m(this,ye,null)}renderTile(e){var l,u;super.renderTile(e);let{x:r,y:i}=e,s=this.tileSize(),o=r*s,d=i*s;if(e.units.length>0&&(n(this,ye)!==null?n(this,ye).tile.id!==e.id:!0)){let[f]=e.units.sort((g,y)=>{var M,X;return((M=y.defence)==null?void 0:M.value)-((X=g.defence)==null?void 0:X.value)}),h=this.renderUnit(f);if(e.units.length>1&&this.putImage(h,o-this.scale(),d-this.scale()),this.putImage(h,o,d),(l=f.improvements)!=null&&l.some(g=>g._==="Fortified")&&this.drawImage("map/fortify",r,i),f.busy){let g=this.tileSize()/2,y=this.tileSize()*.75,M=(u=xr[f.busy._])!=null?u:f.busy._.replace(/[a-z]+/g,"");this.context().font=`bold ${8*this.scale()}px sans-serif`,this.context().fillStyle="black",this.context().textAlign="center",this.context().fillText(M,o+g+this.scale(),d+y+this.scale()),this.context().fillStyle="white",this.context().fillText(M,o+g,d+y)}}}renderUnit(e){let r=e.player,i=r.civilization,[s]=i.attributes.filter(o=>o.name==="colors");return this.replaceColors(this.getPreloadedImage(`units/${e._.toLowerCase()}`),["#60E064","#2C7800"],s.value)}setActiveUnit(e){p(this,ye,e)}activeUnit(){return n(this,ye)}};ye=new WeakMap;var it=ti;var ii=class extends it{render(){this.clear();let t=this.activeUnit();if(t===null)return;let{x:e,y:r}=t.tile,i=this.world().get(e,r),s=this.tileSize(),o=e*s,d=r*s,l=this.renderUnit(t);i.units.length>1&&this.putImage(l,o-this.scale(),d-this.scale()),this.putImage(l,o,d)}update(){this.render()}},ri=ii;var ni=class extends B{renderTile(t){if(!t.city)return;super.renderTile(t);let{x:e,y:r}=t,i=this.tileSize(),s=e*i,o=r*i,d=t.city,l=this.tileSize()/2,u=this.tileSize()*.75,f=this.tileSize()/2,h=this.tileSize()*1.6;this.context().font=`bold ${8*this.scale()}px sans-serif`,this.context().fillStyle="black",this.context().textAlign="center",this.context().fillText(d.growth.size.toString(),s+l+this.scale(),o+u),this.context().fillText(d.name,s+f+this.scale(),o+h),this.context().fillStyle="white",this.context().fillText(d.growth.size.toString(),s+l,o+u-this.scale()),this.context().fillText(d.name,s+f,o+h-this.scale())}update(){this.clear(),this.world().tiles().filter(t=>!!t.city).forEach(t=>this.renderTile(t))}},si=ni;var rt,nt,oi=class extends Y{constructor(e,r,i){super(e);m(this,rt,void 0);m(this,nt,void 0);p(this,rt,r),p(this,nt,i)}build(){this.empty(),this.element().append(c("h3",c("span#year",v(this.year())),c("span#turn",v(`(${n(this,rt).value.toString()})`))))}year(e=n(this,nt).value){return e<0?Math.abs(e)+" BCE":e===0?"1 CE":e+" CE"}};rt=new WeakMap,nt=new WeakMap;var Ui=oi;var ai=class extends gt{bindEvents(){this.canvas().addEventListener("click",t=>{let e=this.center(),r=t.offsetX,i=t.offsetY;for(r=(r-(this.canvas().width/2-this.tileSize()))/(this.tileSize()*this.scale())+e.x,i=(i-(this.canvas().height/2-this.tileSize()))/(this.tileSize()*this.scale())+e.y;r<0;)r+=this.world().width();for(;i<0;)i+=this.world().height();for(;r>this.world().width();)r-=this.world().width();for(;i>this.world().height();)i-=this.world().height();let s=this.world().get(Math.trunc(r),Math.trunc(i)),o=s.units.filter(d=>d.player.id===this.playerId());if(s.city)new xt(s.city,this);else if(o.length){new ie("Activate unit",o.map(d=>({label:d._+(d.busy?` (${d.busy._})`:""),value:d.id})),d=>{let[l]=o.filter(u=>u.id===d);if(!!l){if(!l.active){transport.send("action",{name:"InactiveUnit",id:d});return}this.emit("activate-unit",l)}},null);return}this.setCenter(s.x,s.y)})}},ji=ai;var li=class extends D{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:r}=t;t.goodyHut!==null&&this.drawImage("map/hut",e,r)}},Bi=li;var we,de,di=class{constructor(t=500){m(this,we,!1);m(this,de,[]);setInterval(()=>this.check(),t)}check(){n(this,we)||n(this,de).forEach(t=>t())}clear(){p(this,de,[])}off(t){p(this,de,n(this,de).filter(e=>e!==t))}on(t){n(this,de).push(t)}pause(){p(this,we,!0)}isPaused(){return n(this,we)}resume(){p(this,we,!1)}};we=new WeakMap,de=new WeakMap;var Gi=di;var ci=class extends ve{constructor(t,e,r,i="Please choose one of the following:",s={autoDisplay:!1,canClose:!1,displayAll:!1}){super(t,e,r,i,{...s,autoDisplay:!1,displayAll:!0})}display(){return new Promise(t=>{this.element().addEventListener("selection",({detail:e})=>t(e)),super.display()})}},Xi=ci;var ui=class extends Y{constructor(t){super(t),this.build();let e=document.querySelector('#preload img[src$="main-menu-bg.jpg"]');e.loading?e.addEventListener("load",()=>{t.classList.add("active")}):t.classList.add("active")}build(){this.element().append(c("nav",I(c("button",v("Start a New Game")),{click:()=>{this.disableButtons(),[()=>new Xi("How many players?",[{label:"7 civilizations",value:7},{label:"6 civilizations",value:6},{label:"5 civilizations",value:5},{label:"4 civilizations",value:4},{label:"3 civilizations",value:3}],e=>transport.send("setOption",{name:"players",value:e})).display()].reduce((t,e)=>t.then(()=>e()),Promise.resolve()).then(()=>{this.remove(),transport.send("start")})}}),I(c("button",v("Quit")),{click:()=>{this.remove(),transport.send("quit")}})))}disableButtons(){this.element().querySelectorAll("button").forEach(t=>t.setAttribute("disabled",""))}remove(){this.element().classList.remove("active"),setTimeout(()=>{this.element().remove()},2e3)}},Vi=ui;var U,G,xe,Ae,K,hi=class{constructor(t,e,r,...i){m(this,U,void 0);m(this,G,void 0);m(this,xe,void 0);m(this,Ae,void 0);m(this,K,void 0);p(this,G,t),p(this,K,e),p(this,Ae,r),p(this,xe,i),p(this,U,n(this,G).getContext("2d")),n(this,G).addEventListener("click",s=>{let o=s.offsetX-n(this,G).offsetLeft,d=s.offsetY-n(this,G).offsetTop,l=Math.ceil(o/n(this,G).offsetWidth*n(this,K).width()),u=Math.ceil(d/n(this,G).offsetHeight*n(this,K).height());n(this,Ae).setCenter(l,u),this.update()})}update(){let t=n(this,xe)[0].canvas().height*(190/n(this,xe)[0].canvas().width);n(this,G).height=t,n(this,U).clearRect(0,0,190,t),n(this,xe).forEach(i=>n(this,U).drawImage(i.canvas(),0,0,190,t));let[e,r]=n(this,Ae).visibleRange();n(this,U).lineWidth=1,n(this,U).strokeStyle="#fff",n(this,U).fillStyle="rgba(255, 255, 255, .2)",n(this,U).rect(Math.floor(190/n(this,K).width()*e.x),Math.floor(t/n(this,K).height()*e.y),Math.floor(190/n(this,K).width()*(r.x-e.x)),Math.floor(t/n(this,K).height()*(r.y-e.y))),n(this,U).stroke(),n(this,U).fill()}};U=new WeakMap,G=new WeakMap,xe=new WeakMap,Ae=new WeakMap,K=new WeakMap;var Yi=hi;var st,_e,mi=class{constructor(t=document.body){m(this,st,void 0);m(this,_e,[]);p(this,st,t)}receive(t){n(this,_e).push(t),this.check()}check(){let t=document.querySelector(".notificationWindow");if(!n(this,_e).length||t)return;let e=n(this,_e).shift();this.publish(e)}publish(t){var r;new ut((r=t.title)!=null?r:"Notification",t.message,{parent:n(this,st)}).element().addEventListener("close",()=>this.check())}};st=new WeakMap,_e=new WeakMap;var qi=mi;var ot,pi=class extends Y{constructor(e,r){super(e);m(this,ot,void 0);p(this,ot,r)}build(){this.empty();let{civilization:e,treasury:r,research:i}=n(this,ot);this.element().append(c("h3",v(`${e.leader.name} of the ${e._} empire`)),c("p",v(`Researching ${i.researching?`${i.researching._} (${i.progress.value}/${i.cost.value})`:"nothing"}`)),c("p",v(`Treasury ${r.value}`)))}};ot=new WeakMap;var Fi=pi;var L,fi=class extends Y{constructor(e,r){super(e);m(this,L,void 0);p(this,L,r),this.build()}build(){var e,r;this.empty(),n(this,L)!==null&&this.element().append(c("p",v(`${n(this,L)._} (${n(this,L).tile.x}, ${n(this,L).tile.y})`)),c("p",v((r=(e=n(this,L).city)==null?void 0:e.name)!=null?r:"NONE")),c("p",v(`${n(this,L).moves.value.toFixed(1)} / ${n(this,L).movement.value} moves`)),c("p",v(`A: ${n(this,L).attack.value} / D: ${n(this,L).defence.value} / V: ${n(this,L).visibility.value}`)),c("p",v(`${n(this,L).improvements.map(i=>i._).join(", ")}`)),c("p",v(`${n(this,L).tile.terrain._}${n(this,L).tile.terrain.features?" "+n(this,L).tile.terrain.features.map(i=>i._).join(", "):""}${n(this,L).tile.improvements.length?" ("+n(this,L).tile.improvements.map(i=>i._).join(", ")+")":""}`)),c("p",v(`${n(this,L).tile.units.filter(i=>i!==n(this,L)).map(i=>i._).join(", ")}`)))}};L=new WeakMap;var Ki=fi;var Er={autoEndOfTurn:!0};try{let a=document.getElementById("notification"),t=document.querySelector("#mainmenu"),e=document.getElementById("actions"),r=document.getElementById("other-actions"),i=document.getElementById("game"),s=document.getElementById("map"),o=s.querySelector("canvas"),d=document.getElementById("gameDetails"),l=document.getElementById("playerDetails"),u=document.getElementById("minimap"),f=document.getElementById("unitInfo"),h=new qi,g=new Vi(t),y=(E,W,Z,ce)=>{let V=new Ki(f,E);if(j=E,V.build(),Z.setActiveUnit(E),Z.render(),Z.setVisible(!0),ce.setActiveUnit(E),ce.render(),ce.setVisible(!0),E===null){W.render();return}P=E,Z.update([...P!=null&&P.tile?[P.tile]:[],E.tile]),W.isVisible(E.tile.x,E.tile.y)||W.setCenter(E.tile.x,E.tile.y),W.render()},M=[],X,P=null,j=null;transport.receive("notification",E=>{a.innerHTML=E,X&&window.clearTimeout(X),X=window.setTimeout(()=>{X=void 0,a.innerText=""},4e3)}),[["chooseCivilization","Choose your civilization"],["chooseLeader","Choose your leader"]].forEach(([E,W])=>transport.receive(E,Z=>{let{choices:ce}=lt(Z);new ie(W,ce.map(({_:V})=>({label:V,value:V})),V=>transport.send(E,V),W,{displayAll:!0})})),transport.receiveOnce("gameData",E=>{let W=lt(E),Z=new Intl.ListFormat;new ut("Welcome",c("div.welcome",c("p",v(`${W.player.civilization.leader.name}, you have risen to become leader of the ${W.player.civilization._}.`)),c("p",v(`Your people have knowledge of ${Z.format(["Irrigation","Mining","Roads",...W.player.research.complete.map(b=>b._)])}`)))),i.classList.add("active"),o.width=o.parentElement.offsetWidth,o.height=o.parentElement.offsetHeight;let ce=2,V=new wt(W.player.world),at=[],Qi=new Gi,T=new ji(V,o,{playerId:W.player.id,scale:ce,tileSize:16},Fe,ft,bt,pt,ht,Bi,mt,Me,it,qe,si,ri),Ji=T.getLayer(Fe),Et=T.getLayer(Me),He=T.getLayer(it),Tt=T.getLayer(qe),vi=T.getLayer(si),Oe=T.getLayer(ri);Et.setVisible(!1);let Lt=new Yi(u,V,T,Ji,Tt),gi=new ei(e,T),Zi=new ei(r,T);T.on("focus-changed",()=>Lt.update()),T.on("activate-unit",b=>y(b,T,He,Oe)),Qi.on(()=>{Oe.setVisible(!Oe.isVisible()),T.build(M.splice(0)),T.render()}),window.addEventListener("resize",()=>{o.width=o.parentElement.offsetWidth,o.height=o.parentElement.offsetHeight});let bi=1,Ct=!1,It=b=>{let x=Ct?[]:null,w=lt(b,x);x&&((S=>{for(let We=0,nr=Math.ceil(S.length/1e3);We<nr;We++)setTimeout(()=>S.slice(We*1e3,(We+1)*1e3-1).forEach(sr=>delete b.objects[sr]),(We+1)*200)})(x),Ct=!1),document.dispatchEvent(new CustomEvent("dataupdated",{detail:{data:w}})),bi!==w.turn.value&&(Ct=!0,bi=w.turn.value),gi.build(w.player.mandatoryActions),Zi.build(w.player.actions.filter(S=>["AdjustTradeRates","Revolution"].includes(S._))),i.append(gi.element()),V.setTiles(w.player.world.tiles),new Ui(d,w.turn,w.year).build(),new Fi(l,w.player).build(),at=w.player.actions.filter(S=>S._==="ActiveUnit");let[k]=at.sort(({value:S},{value:ee})=>ee===P?1:S===P?-1:(T.isVisible(ee.tile.x,ee.tile.y)?1:0)-(T.isVisible(S.tile.x,S.tile.y)?1:0));if(P!==(k==null?void 0:k.value)&&(P=null),y(P!=null&&P.active?P:k?k.value:null,T,He,Oe),T.build(M.splice(0)),T.render(),Lt.update(),Er.autoEndOfTurn&&w.player.mandatoryActions.length===1&&w.player.mandatoryActions.every(S=>S._==="EndTurn")){transport.send("action",{name:"EndTurn"});return}};It(E),transport.receive("gameData",b=>{console.log("gameData called again"),It(b)});let er=b=>b.replace(/]/g,"").split(/[.[]/),yi=(b,x)=>{let w=er(x),C=w.pop();return[w.reduce((k,S)=>!k||!(S in k)?null:k[S],b),C]},tr=(b,x,w)=>{let[C,z]=yi(b,x);if(!C||!z){console.warn(`unable to set ${x} of ${b} (${z})`);return}C[z]=w},ir=(b,x)=>{let[w,C]=yi(b,x);if(!w||!C){console.warn(`unable to set ${x} of ${b} (${C})`);return}delete w[C]};transport.receive("gameDataPatch",b=>{b.forEach(x=>Object.entries(x).forEach(([w,{type:C,index:z,value:k}])=>{if(C==="add"||C==="update"){if(!k.hierarchy){console.error("No hierarchy"),console.error(k);return}z?tr(E.objects[w],z,k.hierarchy):E.objects[w]=k.hierarchy,document.dispatchEvent(new CustomEvent("patchdatareceived",{detail:{value:k}})),Object.entries(k.objects).forEach(([S,ee])=>{E.objects[S]=ee,ee._==="PlayerTile"&&M.push(ee)})}if(C==="remove"){if(z){ir(E.objects[w],z);return}delete E.objects[w]}})),It(E)}),transport.receive("gameNotification",b=>h.receive(b));let wi={" ":["NoOrders"],b:["FoundCity"],D:["Disband"],f:["Fortify","BuildFortress"],i:["BuildIrrigation","ClearForest","ClearSwamp","ClearJungle"],m:["BuildMine","PlantForest"],P:["Pillage"],r:["BuildRoad","BuildRailroad"],s:["Sleep"],u:["Unload"],w:["Wait"]},Mt={ArrowUp:"n",PageUp:"ne",ArrowRight:"e",PageDown:"se",ArrowDown:"s",End:"sw",ArrowLeft:"w",Home:"nw"},rr={8:"n",9:"ne",6:"e",3:"se",2:"s",1:"sw",4:"w",7:"nw"},Tr={[KeyboardEvent.DOM_KEY_LOCATION_STANDARD]:Mt,[KeyboardEvent.DOM_KEY_LOCATION_NUMPAD]:rr},xi="";document.addEventListener("keydown",b=>{if(j){if(b.key in wi){let x=[...wi[b.key]];for(;x.length;){let w=x.shift(),[C]=j.actions.filter(z=>z._===w);if(C){transport.send("action",{name:"ActiveUnit",id:j.id,unitAction:C._,target:C.to.id}),b.stopPropagation(),b.preventDefault();return}}}if(b.key in Mt){let[x]=j.actionsForNeighbours[Mt[b.key]];if(x){transport.send("action",{name:"ActiveUnit",id:j.id,unitAction:x._,target:x.to.id}),b.stopPropagation(),b.preventDefault();return}}}if(b.key==="Escape"&&document.activeElement!==null){document.activeElement.blur();return}if(b.key==="Enter"&&W.player.mandatoryActions.some(x=>x._==="EndOfTurn")){transport.send("action",{name:"EndTurn"}),b.stopPropagation(),b.preventDefault();return}if(b.key==="Tab"){let x=e.querySelector("div.action:first-child button");if(x!==null){x.focus(),b.preventDefault(),b.stopPropagation();return}}if(b.key==="c"&&j){T.setCenter(j.tile.x,j.tile.y),T.render(),Lt.update();return}if(b.key==="w"&&j&&at.length>1){let x=at.map(z=>z.value),w=x.indexOf(j),C=x[w===x.length-1?0:w+1];y(C,T,He,Oe)}if(b.key==="t"){He.setVisible(!He.isVisible()),Tt.setVisible(!Tt.isVisible()),vi.setVisible(!vi.isVisible()),T.render();return}if(b.key==="y"){Et.setVisible(!Et.isVisible()),T.render();return}if(xi==="%"&&b.key==="^"){transport.send("cheat",{name:"RevealMap"});return}xi=b.key})})}catch(a){console.error(a)}})();
//# sourceMappingURL=renderer.js.map
