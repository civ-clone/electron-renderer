"use strict";(()=>{var yr=Object.create;var _i=Object.defineProperty;var wr=Object.getOwnPropertyDescriptor;var xr=Object.getOwnPropertyNames;var Er=Object.getPrototypeOf,Tr=Object.prototype.hasOwnProperty;var Cr=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports);var Lr=(a,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of xr(t))!Tr.call(a,r)&&r!==e&&_i(a,r,{get:()=>t[r],enumerable:!(i=wr(t,r))||i.enumerable});return a};var Ir=(a,t,e)=>(e=a!=null?yr(Er(a)):{},Lr(t||!a||!a.__esModule?_i(e,"default",{value:a,enumerable:!0}):e,a));var Oi=(a,t,e)=>{if(!t.has(a))throw TypeError("Cannot "+e)};var o=(a,t,e)=>(Oi(a,t,"read from private field"),e?e.call(a):t.get(a)),p=(a,t,e)=>{if(t.has(a))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(a):t.set(a,e)},h=(a,t,e,i)=>(Oi(a,t,"write to private field"),i?i.call(a,e):t.set(a,e),e);var Yi=Cr((mo,Jt)=>{"use strict";var Ar=Object.prototype.hasOwnProperty,U="~";function Ke(){}Object.create&&(Ke.prototype=Object.create(null),new Ke().__proto__||(U=!1));function Hr(a,t,e){this.fn=a,this.context=t,this.once=e||!1}function Xi(a,t,e,i,r){if(typeof e!="function")throw new TypeError("The listener must be a function");var n=new Hr(e,i||a,r),s=U?U+t:t;return a._events[s]?a._events[s].fn?a._events[s]=[a._events[s],n]:a._events[s].push(n):(a._events[s]=n,a._eventsCount++),a}function yt(a,t){--a._eventsCount===0?a._events=new Ke:delete a._events[t]}function H(){this._events=new Ke,this._eventsCount=0}H.prototype.eventNames=function(){var t=[],e,i;if(this._eventsCount===0)return t;for(i in e=this._events)Ar.call(e,i)&&t.push(U?i.slice(1):i);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(e)):t};H.prototype.listeners=function(t){var e=U?U+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var r=0,n=i.length,s=new Array(n);r<n;r++)s[r]=i[r].fn;return s};H.prototype.listenerCount=function(t){var e=U?U+t:t,i=this._events[e];return i?i.fn?1:i.length:0};H.prototype.emit=function(t,e,i,r,n,s){var l=U?U+t:t;if(!this._events[l])return!1;var d=this._events[l],u=arguments.length,f,m;if(d.fn){switch(d.once&&this.removeListener(t,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,e),!0;case 3:return d.fn.call(d.context,e,i),!0;case 4:return d.fn.call(d.context,e,i,r),!0;case 5:return d.fn.call(d.context,e,i,r,n),!0;case 6:return d.fn.call(d.context,e,i,r,n,s),!0}for(m=1,f=new Array(u-1);m<u;m++)f[m-1]=arguments[m];d.fn.apply(d.context,f)}else{var b=d.length,y;for(m=0;m<b;m++)switch(d[m].once&&this.removeListener(t,d[m].fn,void 0,!0),u){case 1:d[m].fn.call(d[m].context);break;case 2:d[m].fn.call(d[m].context,e);break;case 3:d[m].fn.call(d[m].context,e,i);break;case 4:d[m].fn.call(d[m].context,e,i,r);break;default:if(!f)for(y=1,f=new Array(u-1);y<u;y++)f[y-1]=arguments[y];d[m].fn.apply(d[m].context,f)}}return!0};H.prototype.on=function(t,e,i){return Xi(this,t,e,i,!1)};H.prototype.once=function(t,e,i){return Xi(this,t,e,i,!0)};H.prototype.removeListener=function(t,e,i,r){var n=U?U+t:t;if(!this._events[n])return this;if(!e)return yt(this,n),this;var s=this._events[n];if(s.fn)s.fn===e&&(!r||s.once)&&(!i||s.context===i)&&yt(this,n);else{for(var l=0,d=[],u=s.length;l<u;l++)(s[l].fn!==e||r&&!s[l].once||i&&s[l].context!==i)&&d.push(s[l]);d.length?this._events[n]=d.length===1?d[0]:d:yt(this,n)}return this};H.prototype.removeAllListeners=function(t){var e;return t?(e=U?U+t:t,this._events[e]&&yt(this,e)):(this._events=new Ke,this._eventsCount=0),this};H.prototype.off=H.prototype.removeListener;H.prototype.addListener=H.prototype.on;H.prefixed=U;H.EventEmitter=H;typeof Jt<"u"&&(Jt.exports=H)});var Mr=a=>{let t=[],e={},i=[],r="div";return a.replace(/(?!<\\)(["']).+?(?!<\\)(\1)/g,s=>"string$"+(i.push(s.slice(1,-1))-1)).split(/(?=[.#[])/).forEach(s=>{var l;if(!s.match(/^[.#\[]/)){r=s;return}if(s[0]==="."){t.push(s.slice(1));return}if(s[0]==="#"){e.id=s[0].slice(1);return}if(s[0]==="["){let d=s.match(/\[([^=]+)(=(["']?)(.+?)\3)?]/);d!==null&&(e[d[1]]=((l=d[4])!=null?l:"").replace(/string\$(\d+)/,(u,f)=>i[f]));return}}),[r,t,e]},g=a=>document.createTextNode(a),c=(a,...t)=>{let[e,i,r]=Mr(a),n=document.createElement(e);return i.length&&n.classList.add(...i),Pr(n,r),t.length&&n.append(...t),n};var Pr=(a,t)=>(Object.entries(t).forEach(([e,i])=>a.setAttribute(e,i)),a),L=(a,t)=>(Object.entries(t).forEach(([e,i])=>a.addEventListener(e,i)),a);var dt=({hierarchy:a,objects:t},e=null)=>{let i=new Map;e&&Object.keys(t).forEach(n=>e.push(n));let r=n=>{if(i.has(n))return i.get(n);if(Array.isArray(n)){let s=[];return i.set(n,s),n.forEach(l=>s.push(r(l))),s}if(n&&n["#ref"]){if(e&&e.splice(e.indexOf(n["#ref"]),1),!(n["#ref"]in t))throw new TypeError(`missing ${n["#ref"]}`);let s=r(t[n["#ref"]]);return i.set(n,s),s}if(n instanceof Object){let s={};return i.set(n,s),Object.entries(n).forEach(([l,d])=>{s[l]=r(d)}),s}return n};return r(a)};var pe,he=class{constructor(t=c("div")){p(this,pe,void 0);h(this,pe,t)}build(...t){}element(){return o(this,pe)}empty(){for(;o(this,pe).firstChild!==null;)o(this,pe).firstChild.remove()}};pe=new WeakMap;var N=he;var ze,me,_t=class{constructor(t){p(this,ze,void 0);p(this,me,void 0);h(this,ze,t),h(this,me,c("div.action")),o(this,me).addEventListener("keydown",e=>{e.key!=="Escape"&&e.stopPropagation()}),this.build()}activate(){}build(){}complete(){let t=new CustomEvent("actioned",{bubbles:!0,detail:this});o(this,me).dispatchEvent(t)}element(){return o(this,me)}value(){return o(this,ze).value}};ze=new WeakMap,me=new WeakMap;var Y=_t;var Sr=(a,t)=>c("fieldset",c("legend",g(a)),c(`input[type="range"][max="100"][min="0"][step="1"][value="${t}"]`),c('input[type="number"]'),c("label",c('input[type="checkbox"]'),g("Lock"))),We,$,V,Te,Ne,Ot=class extends N{constructor(e,i){super(Sr(e,i));p(this,We,void 0);p(this,$,void 0);p(this,V,void 0);p(this,Te,void 0);p(this,Ne,[]);h(this,We,e),h(this,$,this.element().querySelector('input[type="range"]')),h(this,V,this.element().querySelector('input[type="number"]')),h(this,Te,this.element().querySelector('input[type="checkbox"]')),this.build()}build(){this.set(o(this,$).value),o(this,$).addEventListener("input",()=>this.set(o(this,$).value)),o(this,V).addEventListener("input",()=>this.set(o(this,V).value)),o(this,Te).addEventListener("input",()=>this.lock()),this.lock()}label(){return o(this,We)}lock(){if(this.isLocked()){o(this,$).setAttribute("disabled",""),o(this,V).setAttribute("disabled","");return}o(this,$).removeAttribute("disabled"),o(this,V).removeAttribute("disabled")}onInput(e){o(this,Ne).push(e)}isLocked(){return o(this,Te).checked}set(e){e=Math.max(parseInt(e,10),0).toString(),o(this,$).value!==e&&(o(this,$).value=e),o(this,V).value!==e&&(o(this,V).value=e),o(this,Ne).forEach(i=>i())}value(){return parseInt(o(this,$).value,10)}};We=new WeakMap,$=new WeakMap,V=new WeakMap,Te=new WeakMap,Ne=new WeakMap;var Ui=Ot;var ee,Ut=class{constructor(...t){p(this,ee,void 0);h(this,ee,t),o(this,ee).forEach(e=>e.onInput(()=>{if(this.total()===100)return;let i=o(this,ee).filter(n=>n!==e),r=i.filter(n=>!n.isLocked());if(this.total()!==100&&r.length===0){e.set((100-this.total(i)).toString());return}if(this.total()>100){let n=this.total()-100,s=Math.ceil(n/r.length);r.forEach(l=>{l.set((l.value()-Math.min(s,n)).toString()),n-=s}),this.total()>100&&e.set((100-this.total(i)).toString())}if(this.total()<100){let n=100-this.total(),s=Math.ceil(n/r.length);r.forEach(l=>{l.set((l.value()+Math.min(s,n)).toString()),n-=s}),this.total()<100&&e.set((100-this.total(i)).toString())}}))}sliders(){return o(this,ee)}total(t=o(this,ee)){return t.reduce((e,i)=>e+i.value(),0)}};ee=new WeakMap;var Di=Ut;var Ce,Dt=class extends he{constructor(e,i=c("div")){super(i);p(this,Ce,void 0);this.element().addEventListener("keydown",r=>{r.stopPropagation()}),this.element().setAttribute("tabindex","0"),h(this,Ce,e)}display(){this.build(),o(this,Ce).append(this.element())}parent(){return o(this,Ce)}};Ce=new WeakMap;var zi=Dt;var Wi={autoDisplay:!0,canClose:!0,canMaximise:!1,canResize:!1,parent:document.body,position:"auto",size:"auto"},fe,Re,$e=class extends zi{constructor(e,i,r={}){var n;super((n=r.parent)!=null?n:Wi.parent,c("div.window"));p(this,fe,void 0);p(this,Re,void 0);this.options={...Wi,...r},h(this,fe,i),h(this,Re,e),this.options.size==="auto"&&this.element().classList.add("size-auto"),this.options.size==="maximised"&&this.element().classList.add("maximised"),this.options.size!=="auto"&&["height","width"].forEach(s=>{let l=this.options.size[s];if(typeof l=="number"){this.element().style[s]=l+"px";return}this.element().style[s]=l}),this.options.position==="auto"&&this.element().classList.add("position-auto"),this.options.position!=="auto"&&[["x","left"],["y","top"]].forEach(([s,l])=>{this.element().style[l]=Math.min(0,Math.max(document.body.clientHeight-20,this.options.position[s]))+"px"}),this.options.autoDisplay&&this.display()}build(){this.empty();let e=[[this.options.canMaximise,L(c('button.maximise[aria-label="Maximise"]',g("Maximise"),c('img.maximise[src="../../node_modules/feather-icons/dist/icons/maximize.svg"][alt="Maximise"]'),c('img.restore[src="../../node_modules/feather-icons/dist/icons/minimize.svg"][alt="Restore"]')),{click:()=>this.maximise()})],[this.options.canClose,L(c('button.close[aria-label="Close"]',g("Close"),c('img[src="../../node_modules/feather-icons/dist/icons/x.svg"][alt="Close"]')),{click:()=>this.close()})]].filter(([i])=>i).map(([,i])=>i);this.element().append(L(c("header",c("h3",g(o(this,Re))),...e),{dblclick:()=>this.maximise()}),c("div.body",o(this,fe)instanceof Node?o(this,fe):c("p",g(o(this,fe))))),this.element().addEventListener("keydown",i=>{i.key==="Escape"&&this.options.canClose&&this.close(),i.stopPropagation()})}close(){this.element().remove(),this.element().dispatchEvent(new CustomEvent("close"))}display(e=!0){super.display(),e&&this.element().focus()}maximise(){!this.options.canMaximise||this.element().classList.toggle("maximised")}update(e){this.element().lastElementChild.remove(),this.element().append(e instanceof Node?e:c("p",g(e)))}};fe=new WeakMap,Re=new WeakMap;var ct=$e;var je,zt=class extends Y{constructor(){super(...arguments);p(this,je,void 0)}activate(){let e=[];new ct("Adjust trade rates",c("div",...this.value().all.map(r=>{let n=new Ui(r._,r.value*100);return e.push(n),n.element()}))).element().addEventListener("close",()=>{transport.send("action",{name:"AdjustTradeRates",id:this.value().id,value:o(this,je).sliders().map(r=>[r.label(),parseFloat((r.value()/100).toFixed(2))])})}),h(this,je,new Di(...e))}build(){this.element().append(c('button.adjustTradeRates[title="Adjust trade rates"]'))}value(){return super.value()}};je=new WeakMap;var Ni=zt;var Wt=[],Be,ut=class extends $e{constructor(e,i,r={}){let n={queue:!0,...r};super(e,i,n);p(this,Be,{});h(this,Be,n),this.element().classList.add("notificationWindow"),this.element().addEventListener("keydown",s=>{s.key==="Enter"&&(this.close(),s.stopPropagation())})}close(){if(super.close(),o(this,Be).queue&&Wt.length&&ut.hasOpenWindow()){let[e,i,r]=Wt.shift();e.display(i),r()}}display(e=!0){return new Promise(i=>{if(ut.hasOpenWindow()){Wt.push([this,e,i]);return}if(super.display(),!e){i(void 0);return}this.element().focus(),i(void 0)})}static hasOpenWindow(){return!!document.querySelector("div.notificationWindow")}},ge=ut;Be=new WeakMap;var pt=ge;var Ge,Fe,ve=class extends ge{constructor(e,i,r,n="Please choose one of the following:",s={}){s={autoFocus:!0,displayAll:!1,...s,actions:{primary:{label:"OK",action:u=>l(u.selectionList().value)},...s.actions}};let l=u=>{this.element().dispatchEvent(new CustomEvent("selection",{detail:u})),this.close(),r(u)},d=L(c("select",...i.map(u=>c(`option[value="${u.value}"]`,g(u.label||u.value)))),{keydown:u=>{u.key==="Enter"&&l(d.value)},dblclick:()=>l(d.value)});s.displayAll&&i.length>1&&d.setAttribute("size",i.length.toString()),s.autoFocus&&d.setAttribute("autofocus","");super(e,c("div",...n instanceof Node?[n]:n===null?[]:[c("p",g(n))],d,c("footer",...Object.entries(s.actions).map(([,{label:u,action:f}])=>L(c("button",g(u)),{click:()=>f(this),keydown:m=>{m.key==="Enter"&&f(this)}})))));p(this,Ge,()=>this.resize());p(this,Fe,void 0);this.element().classList.add("selectionWindow"),h(this,Fe,d),this.resize(),window.addEventListener("resize",o(this,Ge))}close(){window.removeEventListener("resize",o(this,Ge)),super.close()}display(){return super.display(!1).then(()=>{let e=this.element().querySelector("select");e&&e.hasAttribute("autofocus")&&e.focus()})}resize(){var e,i;try{this.selectionList().style.maxHeight="none",this.selectionList().style.maxHeight=`calc(${this.element().offsetHeight-3-this.element().firstElementChild.offsetHeight-((i=(e=this.selectionList().previousElementSibling)==null?void 0:e.offsetHeight)!=null?i:0)-this.selectionList().nextElementSibling.offsetHeight}px - 2em)`}catch(r){console.warn(r)}}selectionList(){return o(this,Fe)}};Ge=new WeakMap,Fe=new WeakMap;var te=ve;var Nt=class extends Y{activate(){let t=new te("Choose research",this.value().available.map(e=>({value:e._})),e=>{!e||(transport.send("action",{name:"ChooseResearch",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which advance would you like to research next?",{displayAll:!0})}build(){this.element().append(c('button.chooseResearch[title="Choose research"]'))}value(){return super.value()}},$i=Nt;var Ri,ji=a=>Ri=a,$t=a=>{let t=Ri.querySelector(`[src$="${a}.png"]`);return t===null?(console.error(`Missing image: ${a}.`),c("canvas")):t},Rt=$t;var kr=(a,t,e)=>{let i=c("canvas"),r=i.getContext("2d");i.width=a.width,i.height=a.height,r.drawImage(a,0,0,a.width,a.height);let n=r.getImageData(0,0,i.width,i.height),s=u=>{var b;let f=null,m={r:0,g:0,b:0,a:0};return typeof u=="string"?(f=u.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i))!==null?m={r:parseInt(f[1],16),g:parseInt(f[2],16),b:parseInt(f[3],16),a:1}:(f=u.match(/^#([0-9a-fA-F])([0-9a-fA-F])([0-9a-fA-F])$/))!==null?m={r:parseInt(f[1]+f[1],16),g:parseInt(f[2]+f[2],16),b:parseInt(f[3]+f[3],16),a:1}:(f=u.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/))!==null?m={r:parseInt(f[1]),g:parseInt(f[2]),b:parseInt(f[3]),a:1}:(f=u.match(/^rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+|\d+\.|\.\d+|\d+\.\d+)\s*\)\s*$/))!==null&&(m={r:parseInt(f[1]),g:parseInt(f[2]),b:parseInt(f[3]),a:parseFloat((b=f[4])!=null?b:1)}):"length"in u&&(m={r:u[0]||0,g:u[1]||0,b:u[2]||0,a:u[3]||1}),m},l=t.map(s),d=e.map(s);for(let u=0;u<n.data.length;u+=4)l.forEach((f,m)=>{n.data[u]===f.r&&n.data[u+1]===f.g&&n.data[u+2]===f.b&&n.data[u+3]===f.a*255&&(n.data[u]=(d[m]||d[0]).r,n.data[u+1]=(d[m]||d[0]).g,n.data[u+2]=(d[m]||d[0]).b,n.data[u+3]=Math.trunc((d[m]||d[0]).a*255))});return r.putImageData(n,0,0),i},ht=kr;var ie,be,Xe,re,Ye,ne,G=class{constructor(t,e=2,i=16,r=c("canvas")){p(this,ie,void 0);p(this,be,void 0);p(this,Xe,!0);p(this,re,void 0);p(this,Ye,void 0);p(this,ne,void 0);h(this,ie,r),h(this,ne,t),h(this,Ye,i),h(this,re,e),this.setCanvasSize(),h(this,be,o(this,ie).getContext("2d")),ji(document.querySelector("#preload"))}canvas(){return o(this,ie)}clear(){this.context().clearRect(0,0,this.canvas().width,this.canvas().height)}context(){return o(this,be)}render(t=this.world().tiles()){this.clear(),t.forEach(({x:e,y:i})=>this.renderTile(this.world().get(e,i)))}renderTile({x:t,y:e}){let i=this.tileSize(),r=t*i,n=e*i;this.context().clearRect(r,n,i,i)}scale(){return o(this,re)}tileSize(){return o(this,Ye)*o(this,re)}update(t){t.forEach(({x:e,y:i})=>this.renderTile(this.world().get(e,i)))}world(){return o(this,ne)}drawImage(t,e,i,r={}){var u,f;let n=this.tileSize(),s=e*n,l=i*n,d=this.getPreloadedImage(t);this.putImage(r.augment?r.augment(d):d,s+((u=r.offsetX)!=null?u:0),l+((f=r.offsetY)!=null?f:0))}filterNeighbours(t,e,i=["n","e","s","w"]){return i.filter(r=>e(o(this,ne).getNeighbour(t,r)))}getPreloadedImage(t){return $t(t)}putImage(t,e,i){o(this,be).imageSmoothingEnabled=!1,o(this,be).drawImage(t,e,i,t.width*o(this,re),t.height*o(this,re))}replaceColours(t,e,i){return ht(t,e,i)}setCanvasSize(){o(this,ie).height=o(this,ne).height()*this.tileSize(),o(this,ie).width=o(this,ne).width()*this.tileSize()}isVisible(){return o(this,Xe)}setVisible(t){h(this,Xe,t)}};ie=new WeakMap,be=new WeakMap,Xe=new WeakMap,re=new WeakMap,Ye=new WeakMap,ne=new WeakMap;var Bi=G;var jt=class extends G{renderTile(t){super.renderTile(t);let{x:e,y:i}=t,r=this.tileSize(),n=e*r,s=i*r;if(t.city){let l=t.city,d=l.player,u=d.civilization,[f]=u.attributes.filter(m=>m.name==="colors");t.units.length>0&&(this.context().fillStyle="#000",this.context().fillRect(n,s,r,r)),this.context().fillStyle=f.value[0],this.context().fillRect(n+this.scale(),s+this.scale(),r-this.scale()*2,r-this.scale()*2),this.drawImage("map/city",e,i,{augment:m=>this.replaceColours(m,["#000"],[f.value[1]]),offsetX:this.scale(),offsetY:this.scale()})}}},Ve=jt;var Bt=class extends ge{constructor(t,e,i,r={}){var s,l;let n=L(c("button",g((s=r.okLabel)!=null?s:"OK")),{click:()=>{i(),this.close()},keydown:d=>{(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),d.stopPropagation(),i(),this.close())}});super(t,c("div.content",c("p",g(e)),c("footer",n,L(c("button",g((l=r.cancelLabel)!=null?l:"Cancel")),{click:()=>this.close(),keydown:d=>{(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),d.stopPropagation(),this.close())}}))),{...r,queue:!1}),n.focus()}},Gi=Bt;var Le,Ie,Gt=class{constructor(t,e){p(this,Le,void 0);p(this,Ie,[]);this.setIds(t),h(this,Le,i=>{let{detail:r}=i,n=r.value.objects;!n||o(this,Ie).some(s=>s in n)&&document.addEventListener("dataupdated",s=>e(s.detail.data),{once:!0})}),document.addEventListener("patchdatareceived",o(this,Le))}dispose(){document.removeEventListener("patchdatareceived",o(this,Le))}setIds(t){o(this,Ie).splice(0,o(this,Ie).length,...t)}};Le=new WeakMap,Ie=new WeakMap;var Fi=Gt;var Ft=class extends G{update(t){let e=[...t];return t.forEach(i=>{["n","ne","e","se","s","sw","w","nw"].forEach(r=>{let n=this.world().getNeighbour(i,r);e.includes(n)||e.push(n)})}),super.update(e)}},z=Ft;var Xt=class extends z{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t;t.terrain.features.length&&t.terrain.features.forEach(r=>r._==="Shield"?this.drawImage(`terrain/${r._.toLowerCase()}`,e,i,{offsetX:4*this.scale(),offsetY:4*this.scale()}):this.drawImage(`terrain/${r._.toLowerCase()}`,e,i))}},mt=Xt;var Yt=class extends z{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t;this.filterNeighbours(t,r=>r.terrain._==="Unknown").forEach(r=>this.drawImage(`map/fog_${r}`,e,i))}},ft=Yt;var Vt=class extends z{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t,r=t.improvements.reduce((n,s)=>{let l=s._;return l in n&&(n[l]=!0),n},{Mine:!1,Road:!1,Railroad:!1,Pollution:!1});if(["Mine","Pollution"].forEach(n=>{r[n]&&this.drawImage(`improvements/${n.toLowerCase()}`,e,i)}),r.Road){let n=this.filterNeighbours(t,l=>l.improvements.some(d=>d._==="Road"),["n","ne","e","se","s","sw","w","nw"]),s=this.filterNeighbours(t,l=>!!l.city||l.improvements.some(d=>d._==="Railroad"),["n","ne","e","se","s","sw","w","nw"]);if(n.forEach(l=>{(!r.Railroad||!s.includes(l))&&this.drawImage(`improvements/road_${l}`,e,i)}),r.Railroad&&s.forEach(l=>this.drawImage(`improvements/railroad_${l}`,e,i)),n.length===0&&s.length===0){let l=this.tileSize(),d=e*l,u=i*l,f=Math.floor(this.tileSize()/2)-this.scale();this.context().fillStyle=r.Railroad?"#000":"#8c5828",this.context().rect(d+f,u+f,this.scale()*2,this.scale()*2),this.context().fill()}}}},gt=Vt;var qt=class extends te{constructor(t,e=()=>{}){super("Activate unit",t.map(i=>{var r,n;return{label:i._+" ["+((n=(r=i.city)==null?void 0:r.name)!=null?n:"NONE")+"]"+(i.busy?` (${i.busy._})`:""),value:i.id}}),i=>{let[r]=t.filter(n=>n.id===i);if(!!r){if(!r.active){transport.send("action",{name:"InactiveUnit",id:i});return}e(r)}},null)}},vt=qt;var Kt=class extends z{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t;!t.improvements.some(n=>n._==="Irrigation")||this.drawImage("improvements/irrigation",e,i)}},bt=Kt;var Qt=class extends z{renderTile(t){super.renderTile(t);let{x:e,y:i}=t,r=this.tileSize(),n=e*r,s=i*r;if(t.terrain._!=="Unknown"){if(t.isLand)this.drawImage("terrain/land",e,i);else if(t.isWater&&(this.drawImage("terrain/ocean",e,i),t.isCoast)){let l=this.getPreloadedImage("terrain/coast_sprite"),d=(this.world().getNeighbour(t,"w").isLand?1:0)|(this.world().getNeighbour(t,"nw").isLand?2:0)|(this.world().getNeighbour(t,"n").isLand?4:0)|(this.world().getNeighbour(t,"ne").isLand?8:0)|(this.world().getNeighbour(t,"e").isLand?16:0)|(this.world().getNeighbour(t,"se").isLand?32:0)|(this.world().getNeighbour(t,"s").isLand?64:0)|(this.world().getNeighbour(t,"sw").isLand?128:0);if(d>0){let u=d&7,f=d>>2&7,m=d>>4&7,b=d>>6&7|(d&1)<<2,y=c('canvas[height="16"][width="16"]'),M=y.getContext("2d");M.drawImage(l,u<<4,0,8,8,0,0,8,8),M.drawImage(l,(f<<4)+8,0,8,8,8,0,8,8),M.drawImage(l,(m<<4)+8,8,8,8,8,8,8,8),M.drawImage(l,b<<4,8,8,8,0,8,8,8),this.putImage(y,n,s)}this.filterNeighbours(t,u=>u.terrain._==="River").forEach(u=>this.drawImage(`terrain/river_mouth_${u}`,e,i))}}}},qe=Qt;var Vi=Ir(Yi());var _r={playerId:null,scale:2,tileSize:16},W,_,ye,R,Qe,K,Je,O,Zt=class extends Vi.EventEmitter{constructor(e,i=c("canvas"),r={playerId:null,scale:2},...n){let s={..._r,...r};super();p(this,W,void 0);p(this,_,{x:0,y:0});p(this,ye,void 0);p(this,R,[]);p(this,Qe,null);p(this,K,void 0);p(this,Je,void 0);p(this,O,void 0);h(this,O,e),h(this,W,i),h(this,Qe,s.playerId),h(this,Je,s.tileSize),h(this,K,s.scale),n.forEach(l=>o(this,R).push(new l(o(this,O),this.scale(),this.tileSize()))),h(this,ye,i.getContext("2d")),this.bindEvents()}bindEvents(){}build(e){o(this,R).forEach(i=>i.update(e))}canvas(){return o(this,W)}center(){return o(this,_)}getLayer(e){var i;return(i=this.getLayers(e).shift())!=null?i:null}getLayers(e){return o(this,R).filter(i=>i instanceof e)}isVisible(e,i){let[r,n,s,l]=this.visibleBounds();return(r>n?e<n||e>r:e<n&&e>r)&&(s>l?i<l||i>s:i<l&&i>s)}playerId(){return o(this,Qe)}render(){let e=o(this,R)[0].tileSize(),i=o(this,O).width()*e,r=o(this,_).x*e+Math.trunc(e/this.scale()),n=Math.trunc(o(this,W).width/2),s=o(this,O).height()*e,l=o(this,_).y*e+Math.trunc(e/this.scale()),d=Math.trunc(o(this,W).height/2),u=n-r,f=n+i,m=d-l,b=d+s;for(;u>0;)u-=i;for(;m>0;)m-=s;for(;f<o(this,W).width;)f+=i;for(;b<o(this,W).height;)b+=s;o(this,ye).fillStyle="#000",o(this,ye).fillRect(0,0,o(this,O).width()*e,o(this,O).height()*e);for(let y=u;y<f;y+=i)for(let M=m;M<b;M+=s)o(this,R).forEach(ce=>{if(!ce.isVisible())return;let P=ce.canvas();o(this,ye).drawImage(P,y,M,P.width,P.height)})}scale(){return o(this,K)}setCenter(e,i){o(this,_).x=e,o(this,_).y=i,this.render(),this.emit("focus-changed",e,i)}tileSize(){return o(this,Je)}visibleBounds(){let e=Math.floor(o(this,W).width/o(this,R)[0].tileSize()/o(this,K)),i=Math.floor(o(this,W).height/o(this,R)[0].tileSize()/o(this,K)),r=(o(this,_).x-e+o(this,O).width())%o(this,O).width(),n=(o(this,_).x+e)%o(this,O).width(),s=(o(this,_).y-i+o(this,O).height())%o(this,O).height(),l=(o(this,_).y+i)%o(this,O).height();return[r,n,s,l]}visibleRange(){let e=Math.floor(o(this,W).width/o(this,R)[0].tileSize()/o(this,K)),i=Math.floor(o(this,W).height/o(this,R)[0].tileSize()/o(this,K));return[{x:o(this,_).x-e,y:o(this,_).y-i},{x:o(this,_).x+e,y:o(this,_).y+i}]}world(){return o(this,O)}};W=new WeakMap,_=new WeakMap,ye=new WeakMap,R=new WeakMap,Qe=new WeakMap,K=new WeakMap,Je=new WeakMap,O=new WeakMap;var wt=Zt;var ei=class extends z{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t,r=this.filterNeighbours(t,n=>t.terrain._==="River"&&n.isWater||t.terrain._===n.terrain._).join("");t.terrain._!=="Ocean"&&(r?this.drawImage(`terrain/${t.terrain._.toLowerCase()}_${r}`,e,i):this.drawImage(`terrain/${t.terrain._.toLowerCase()}`,e,i))}},xt=ei;var Et,Me,oe,se,ae,ti=class{constructor(t){p(this,Et,(t,e)=>({_:"Tile",id:`Tile-${t}--${e}`,city:null,goodyHut:null,improvements:[],isCoast:!1,isLand:!1,isWater:!1,terrain:{_:"Unknown",id:`UnknownTerrain-${t}--${e}`,features:[]},units:[],x:t,y:e,yields:[]}));p(this,Me,{});p(this,oe,void 0);p(this,se,void 0);p(this,ae,void 0);h(this,se,t.height),h(this,ae,t.width),h(this,oe,t.tiles||[])}get(t,e){for(;t<0;)t+=o(this,ae);for(;e<0;)e+=o(this,se);for(;t>=o(this,ae);)t-=o(this,ae);for(;e>=o(this,se);)e-=o(this,se);let i=[t,e].toString();if(!(i in o(this,Me))){let r=o(this,oe).findIndex(n=>n.x===t&&n.y===e);if(r===-1)return o(this,Et).call(this,t,e);o(this,Me)[i]=r}return o(this,oe)[o(this,Me)[i]]}getNeighbour(t,e){if(e==="n")return this.get(t.x,t.y-1);if(e==="ne")return this.get(t.x+1,t.y-1);if(e==="e")return this.get(t.x+1,t.y);if(e==="se")return this.get(t.x+1,t.y+1);if(e==="s")return this.get(t.x,t.y+1);if(e==="sw")return this.get(t.x-1,t.y+1);if(e==="w")return this.get(t.x-1,t.y);if(e==="nw")return this.get(t.x-1,t.y-1);throw new TypeError("Invalid direction.")}height(){return o(this,se)}tiles(){return o(this,oe)}width(){return o(this,ae)}setTiles(t){h(this,oe,t)}};Et=new WeakMap,Me=new WeakMap,oe=new WeakMap,se=new WeakMap,ae=new WeakMap;var Tt=ti;var ii=class extends Bi{renderTile(t){super.renderTile(t);let{x:e,y:i}=t,r=this.tileSize(),n=e*r,s=i*r,l=t.yields.reduce((m,b)=>m+b.value,0),d=t.yields.sort((m,b)=>m._.charCodeAt(0)-b._.charCodeAt(0)),u=0;if(l<5){let m=[[n,s],[n+r/2,s],[n,s+r/2],[n+r/2,s+r/2]];d.forEach(b=>{for(let y=0;y<b.value;y++)this.putImage(this.getPreloadedImage(`city/${b._.toLowerCase()}`),...m[u++])});return}if(l<7){let m=[[n,s],[n+r/3,s],[n+r/3*2,s],[n,s+r/2],[n+r/3,s+r/2],[n+r/3*2,s+r/2]];d.forEach(b=>{for(let y=0;y<b.value;y++)this.putImage(this.getPreloadedImage(`city/${b._.toLowerCase()}`),m[u][0],m[u++][1])});return}if(l<9){let m=[[n,s],[n+r/4,s],[n+r/4*2,s],[n+r/4*3,s],[n,s+r/2],[n+r/4,s+r/2],[n+r/4*2,s+r/2],[n+r/4*3,s+r/2]];d.forEach(b=>{for(let y=0;y<b.value;y++)this.putImage(this.getPreloadedImage(`city/${b._.toLowerCase()}`),...m[u++])});return}if(l<11){let m=[[n,s],[n+r/5,s],[n+r/5*2,s],[n+r/5*3,s],[n+r/5*4,s],[n,s+r/2],[n+r/5,s+r/2],[n+r/5*2,s+r/2],[n+r/5*3,s+r/2],[n+r/5*4,s+r/2]];d.forEach(b=>{for(let y=0;y<b.value;y++)this.putImage(this.getPreloadedImage(`city/${b._.toLowerCase()}`),...m[u++])});return}let f=[[n,s],[n+r/6,s],[n+r/6*2,s],[n+r/6*3,s],[n+r/6*4,s],[n+r/6*5,s],[n,s+r/2],[n+r/6,s+r/2],[n+r/6*2,s+r/2],[n+r/6*3,s+r/2],[n+r/6*4,s+r/2],[n+r/6*5,s+r/2]];d.forEach(m=>{for(let b=0;b<m.value;b++)this.putImage(this.getPreloadedImage(`city/${m._.toLowerCase()}`),...f[u++])})}},Pe=ii;var Or={BuildingIrrigation:"I",BuildingMine:"M",BuildingRoad:"R",BuildingRailroad:"RR"},Ur=(a,t=16)=>{var l,d;let e=a.player,i=e.civilization,[r]=i.attributes.filter(u=>u.name==="colors"),n=ht(Rt(`units/${a._.toLowerCase()}`),["#60E064","#2C7800"],r.value),s=n.getContext("2d");if(s.imageSmoothingEnabled=!1,(l=a.improvements)!=null&&l.some(u=>u._==="Fortified")&&s.drawImage(Rt("map/fortify"),0,0),a.busy){let u=t/2,f=t*.75,m=(d=Or[a.busy._])!=null?d:a.busy._.replace(/[a-z]+/g,"");s.font="bold 8px sans-serif",s.fillStyle="black",s.textAlign="center",s.fillText(m,u,f),s.fillStyle="white",s.fillText(m,u,f)}return n},Ct=Ur;var Ze,ri=class extends N{constructor(e,i=2){super(c('canvas[width="32"][height="32"]'));p(this,Ze,2);h(this,Ze,i),this.build(e)}build(e){let i=Ct(e),r=this.element().getContext("2d");r.imageSmoothingEnabled=!1;let n=this.size(i.width),s=this.size(i.height),l=Math.floor((this.size(16)-n)/2),d=Math.floor((this.size(16)-s)/2);r.drawImage(i,l,d,n,s)}element(){return super.element()}size(e=16){return e*o(this,Ze)}};Ze=new WeakMap;var ni=ri;var Lt={Food:"Food",UnitSupportFood:"Food",PopulationSupportFood:"Food",Production:"Production",UnitSupportProduction:"Production",Trade:"Trade",Corruption:"Trade",Happiness:"Happiness",LuxuryHappiness:"Happiness",Unhappiness:"Unhappiness",MartialLawContent:"Unhappiness",MilitaryUnhappiness:"Unhappiness",PopulationUnhappiness:"Unhappiness",CityImprovementContent:"Unhappiness",Research:"Research",Luxuries:"Luxuries",Gold:"Gold",CityImprovementMaintenanceGold:"Gold"},le=Object.entries(Lt).reduce((a,[t,e])=>(Object.prototype.hasOwnProperty.call(a,e)||(a[e]=[]),a[e].push(t),a),{}),qi={Food:"city/food.png",Production:"city/production.png",Trade:"city/trade.png",Gold:"city/gold.png",Luxuries:"city/luxury.png",Pollution:"city/pollution.png",Research:"city/bulb.png",Unhappiness:"city/sad.png"};var Dr=a=>Math.max(1,Math.ceil((a.build.cost.value-a.build.progress.value)/a.yields.filter(t=>le.Production.includes(t._)).reduce((t,e)=>t+e.value,0))),zr=a=>Math.max(1,Math.ceil((a.growth.cost.value-a.growth.progress.value)/a.yields.filter(t=>le.Food.includes(t._)).reduce((t,e)=>t+e.value,0))),Wr=a=>{let t=a.growth,e=parseInt(a.name.replace(/[^a-z]/gi,""),36).toString(2),[i,r]=a.yields.reduce(([l,d],u)=>(le.Happiness.includes(u._)&&(l+=u.value),le.Unhappiness.includes(u._)&&(d+=u.value),[l,d]),[0,0]),n=new Array(t.size).fill(1),s=n.length-1;for(;r>0&&s>-1;)n[s--]=0,r--;for(s=0;i>0&&s<n.length;)n[s]===0&&(n[s]++,i--),n[s]===1&&(n[s++]++,i--),n[s]===2&&s++;return c("div.population",...n.map((l,d)=>c("span.citizen",c(`img[src="../assets/city/people_${["unhappy","content","happy"][l]}_${["f","m"][parseInt(e[d%e.length],10)]}.png"]`))))},Nr=(a,t)=>t.filter(e=>le[a].includes(e._)).reduce(([e,i],r)=>[e+(r.value<0?-r.value:0),i+r.value],[0,0]),$r=a=>c("div.yields-detail",...[["Food"],["Production"],["Trade"],["Luxuries","Gold","Research"]].map(t=>c(`div.yields[data-yields="${t.join(" ")}"]`,...t.map(e=>c(`span.yield[data-yield="${e}"]`,...Nr(e,a.yields).map((i,r)=>c(`span.${["used","free"][r]}`,...si({id:"",_:e,value:i,values:[]}))))))),...Object.entries(a.yields.filter(t=>!Object.keys(Lt).includes(t._)).reduce((t,e)=>(e._ in t||(t[e._]=0),t[e._]+=e.value,t),{})).map(([t,e])=>c("div",c("div",g(t)),c("div",g(e))))),Rr=(a,t)=>{let e=c("canvas"),i=new wt(new Tt(t.player.world),e,{playerId:t.player.id,scale:a.scale(),tileSize:a.tileSize()},qe,bt,xt,gt,mt,ft,Ve,Pe);return e.height=a.tileSize()*a.scale()*5,e.width=a.tileSize()*a.scale()*5,i.setCenter(t.tile.x,t.tile.y),i.build(t.tiles),i.getLayer(Pe).render(t.tilesWorked),i.render(),L(c("div.city-map",e),{click:()=>transport.send("action",{name:"ReassignWorkers",city:t.id})})},si=a=>new Array(Math.abs(a.value)).fill(0).map(()=>c("span.yield-icon",c(`img[src="../assets/${qi[Lt[a._]]}"]`))),jr=(a,t,e)=>{let i=Dr(a);return c("div.build",c("header",g(`Building ${a.build.building?a.build.building.item._:"nothing"}`)),L(c("button",g(a.build.building?"Change":"Choose")),{click(){t()}}),L(c("button",g("Buy")),{click(){e()}}),a.build.building?c("p",g(`Progress ${a.build.progress.value} / ${a.build.cost.value} (${i} turn${i===1?"":"s"})`)):g(""))},Br=a=>{let t=a.growth,e=zr(a);return c("div.growth",c("header",g("Growth")),c("p",g(`Size ${t.size.toString()}`)),c("p",g(`Progress ${a.build.progress.value} / ${a.build.cost.value} (${e} turn${e===1?"":"s"})`)))},Gr=a=>c("div.improvements",c("div",...a.improvements.map(t=>c("div",g(t._),...a.yields.filter(e=>e._==="CityImprovementMaintenanceGold").filter(e=>e.cityImprovement.id===t.id).flatMap(e=>si(e)))))),Fr=a=>L(c("div.garrisoned-units",c("header",g("Garrisoned Units")),c("div.units",...a.tile.units.map(t=>new ni(t).element()))),{click(){let t=a.tile.units.filter(e=>e.player.id===a.player.id);t.length!==0&&new vt(t)}}),Xr=a=>c("div.supported-units",c("header",g("Supported Units")),c("div.units",...a.units.map(t=>c("span.unit",new ni(t).element(),...a.yields.filter(e=>["UnitSupportFood","UnitSupportProduction","MilitaryUnhappiness"].includes(e._)).filter(e=>e.unit.id===t.id).flatMap(e=>si(e)))))),Ki=(a,t,e,i)=>c("div.city-screen",c("div.top-row",c("div.yield-details",Wr(a),$r(a),Xr(a)),Rr(t,a),Gr(a)),c("div.bottom-row",Br(a),c("div.tabbed-details",c("div.info",Fr(a))),jr(a,e,i))),Q,Se,et,oi=class extends ct{constructor(e,i){super(e.name,Ki(e,i,()=>this.changeProduction(),()=>this.completeProduction()),{size:"maximised"});p(this,Q,void 0);p(this,Se,void 0);p(this,et,void 0);this.element().classList.add("city-screen-window"),h(this,Q,e),h(this,et,i),h(this,Se,new Fi([e.id,e.build.id,e.growth.id,...e.units.map(r=>r.id)],r=>{var s,l;let[n]=((l=(s=r.player)==null?void 0:s.cities)!=null?l:[]).filter(d=>e.id===d.id);if(!n){this.close();return}h(this,Q,n),o(this,Se).setIds([n.id,n.build.id,n.growth.id,...n.units.map(d=>d.id)]),this.update(Ki(n,o(this,et),()=>this.changeProduction(),()=>this.completeProduction())),this.element().focus()})),this.element().addEventListener("keydown",r=>{["c","C"].includes(r.key)&&(this.changeProduction(),r.preventDefault(),r.stopPropagation()),["b","B"].includes(r.key)&&(this.completeProduction(),r.preventDefault(),r.stopPropagation()),["Enter","x","X"].includes(r.key)&&this.close()})}changeProduction(){new ke(o(this,Q).build,()=>this.element().focus())}close(){o(this,Se).dispose(),super.close()}completeProduction(){!o(this,Q).build.building||new Gi("Are you sure?",`Do you want to rush building of ${o(this,Q).build.building.item._}`,()=>transport.send("action",{name:"CompleteProduction",id:o(this,Q).id}))}};Q=new WeakMap,Se=new WeakMap,et=new WeakMap;var It=oi;var tt=class extends ve{constructor(e,i=()=>{},r={}){let n=e.city.yields.filter(l=>l._==="Production").reduce((l,d)=>l+d.value,0),s=l=>Math.ceil((l.cost.value-e.progress.value)/n);super(`What would you like to build in ${e.city.name}?`,e.available.map(l=>({label:`${l.item._} (Cost: ${l.cost.value} / ${s(l)} turn${s(l)===1?"":"s"})`,value:l.item._})),l=>{!l||(transport.send("action",{name:e.building===null?"CityBuild":"ChangeProduction",id:e.id,chosen:l||"@"}),this.close(!0))},null,{actions:r,displayAll:!0});this.onComplete=i}close(e=!1){super.close(),e&&this.onComplete(e)}};tt.showCityAction=(e,i)=>({label:"View city",action(r){r.close(),new It(e,i)}}),tt.showCityOnMapAction=(e,i)=>({label:"Show on map",action(r){r.close(),i.setCenter(e.tile.x,e.tile.y)}});var ke=tt;var Ae,ai=class extends Y{constructor(e,i){super(e);p(this,Ae,void 0);h(this,Ae,i)}activate(){new ke(this.value(),()=>this.complete(),{showCity:ke.showCityAction(this.value().city,o(this,Ae)),showCityOnMap:ke.showCityOnMapAction(this.value().city,o(this,Ae))})}build(){let e=this.value();this.element().append(c(`button.cityBuild[title="What would you like to build in ${e.city.name}?"]`))}value(){return super.value()}};Ae=new WeakMap;var Qi=ai;var li=class extends Y{activate(){transport.send("action",{name:"EndTurn"})}build(){this.element().append(c('button.endTurn[title="End turn"]'))}},Ji=li;var di=class extends Y{activate(){let t=new te("Choose government",this.value().available.map(e=>({value:e._})),e=>{!e||(transport.send("action",{name:"Revolution",id:this.value().id,chosen:e||"@"}),this.complete(),t.close())},"Which government would you like to convert to?",{displayAll:!0})}build(){this.element().append(c('button.chooseGovernment[title="Choose government"]'))}value(){return super.value()}},Zi=di;var it,ci=class extends he{constructor(e=c("div.actions"),i){super(e);p(this,it,void 0);h(this,it,i),this.element().addEventListener("actioned",r=>r.detail.element().remove()),this.element().addEventListener("keydown",r=>{var f;let n=document.activeElement;if(!this.element().contains(n))return;let{key:s}=r,l=Array.from(this.element().children);if(!["ArrowDown","ArrowLeft","ArrowRight","ArrowUp"].includes(s)||l.length===0)return;r.preventDefault(),r.stopPropagation();let d=n===this.element()?["ArrowLeft","ArrowUp"].includes(s)?n.firstElementChild:n.lastElementChild:n;for(;d.parentElement!==this.element();)d=d.parentElement;let u=l.indexOf(d);if(["ArrowUp","ArrowLeft"].includes(s)){if(u>0){(f=l[u-1].querySelector("button"))==null||f.focus();return}l.pop().querySelector("button").focus();return}if(["ArrowDown","ArrowRight"].includes(s)){if(u<l.length-1){l[u+1].querySelector("button").focus();return}l.shift().querySelector("button").focus();return}},!0)}build(e){this.empty(),e.forEach(i=>{let r;switch(i._){case"ActiveUnit":return;case"AdjustTradeRates":r=new Ni(i);break;case"ChooseResearch":r=new $i(i);break;case"CityBuild":r=new Qi(i,o(this,it));break;case"EndTurn":r=new Ji(i);break;case"Revolution":r=new Zi(i);break;default:console.log("need to handle "+i._);return}this.element().prepend(L(r.element(),{click:()=>r.activate(),keydown:({key:n})=>{(n===" "||n==="Enter")&&r.activate()}}))})}};it=new WeakMap;var ui=ci;var we,pi=class extends G{constructor(){super(...arguments);p(this,we,null)}renderTile(e){super.renderTile(e);let{x:i,y:r}=e,n=this.tileSize(),s=i*n,l=r*n;if(e.units.length>0&&(o(this,we)!==null?o(this,we).tile.id!==e.id:!0)){let[d]=e.units.sort((f,m)=>{var b,y;return((b=m.defence)==null?void 0:b.value)-((y=f.defence)==null?void 0:y.value)}),u=this.renderUnit(d);e.units.length>1&&this.putImage(u,s-this.scale(),l-this.scale()),this.putImage(u,s,l)}}renderUnit(e){return Ct(e)}setActiveUnit(e){h(this,we,e)}activeUnit(){return o(this,we)}};we=new WeakMap;var rt=pi;var hi=class extends rt{render(){this.clear();let t=this.activeUnit();if(t===null)return;let{x:e,y:i}=t.tile,r=this.world().get(e,i),n=this.tileSize(),s=e*n,l=i*n,d=this.renderUnit(t);r.units.length>1&&this.putImage(d,s-this.scale(),l-this.scale()),this.putImage(d,s,l)}update(){this.render()}},mi=hi;var fi=class extends G{renderTile(t){if(!t.city)return;super.renderTile(t);let{x:e,y:i}=t,r=this.tileSize(),n=e*r,s=i*r,l=t.city,d=this.tileSize()/2,u=this.tileSize()*.75,f=this.tileSize()/2,m=this.tileSize()*1.6;this.context().font=`bold ${8*this.scale()}px sans-serif`,this.context().fillStyle="black",this.context().textAlign="center",this.context().fillText(l.growth.size.toString(),n+d+this.scale(),s+u),this.context().fillText(l.name,n+f+this.scale(),s+m),this.context().fillStyle="white",this.context().fillText(l.growth.size.toString(),n+d,s+u-this.scale()),this.context().fillText(l.name,n+f,s+m-this.scale())}update(){this.clear(),this.world().tiles().filter(t=>!!t.city).forEach(t=>this.renderTile(t))}},gi=fi;var nt,ot,vi=class extends N{constructor(e,i,r){super(e);p(this,nt,void 0);p(this,ot,void 0);h(this,nt,i),h(this,ot,r)}build(){this.empty(),this.element().append(c("h3",c("span#year",g(this.year())),c("span#turn",g(`(${o(this,nt).value.toString()})`))))}year(e=o(this,ot).value){return e<0?Math.abs(e)+" BCE":e===0?"1 CE":e+" CE"}};nt=new WeakMap,ot=new WeakMap;var er=vi;var bi=class extends wt{bindEvents(){this.canvas().addEventListener("click",t=>{let e=this.center(),i=t.offsetX,r=t.offsetY;for(i=(i-(this.canvas().width/2-this.tileSize()))/(this.tileSize()*this.scale())+e.x,r=(r-(this.canvas().height/2-this.tileSize()))/(this.tileSize()*this.scale())+e.y;i<0;)i+=this.world().width();for(;r<0;)r+=this.world().height();for(;i>this.world().width();)i-=this.world().width();for(;r>this.world().height();)r-=this.world().height();let n=this.world().get(Math.trunc(i),Math.trunc(r)),s=n.units.filter(l=>l.player.id===this.playerId());if(n.city)new It(n.city,this);else if(s.length){new vt(s,l=>this.emit("activate-unit",l));return}this.setCenter(n.x,n.y)})}},tr=bi;var yi=class extends z{renderTile(t){if(super.renderTile(t),t.terrain._==="Unknown")return;let{x:e,y:i}=t;t.goodyHut!==null&&this.drawImage("map/hut",e,i)}},ir=yi;var xe,de,wi=class{constructor(t=500){p(this,xe,!1);p(this,de,[]);setInterval(()=>this.check(),t)}check(){o(this,xe)||o(this,de).forEach(t=>t())}clear(){h(this,de,[])}off(t){h(this,de,o(this,de).filter(e=>e!==t))}on(t){o(this,de).push(t)}pause(){h(this,xe,!0)}isPaused(){return o(this,xe)}resume(){h(this,xe,!1)}};xe=new WeakMap,de=new WeakMap;var rr=wi;var xi=class extends ve{constructor(t,e,i,r="Please choose one of the following:",n={autoDisplay:!1,canClose:!1,displayAll:!1}){super(t,e,i,r,{...n,autoDisplay:!1,displayAll:!0})}display(){return new Promise(t=>{this.element().addEventListener("selection",({detail:e})=>t(e)),super.display()})}},nr=xi;var Ei=class extends N{constructor(t){super(t),this.build();let e=document.querySelector('#preload img[src$="main-menu-bg.jpg"]');e.loading?e.addEventListener("load",()=>{t.classList.add("active")}):t.classList.add("active")}build(){this.element().append(c("nav",L(c("button",g("Start a New Game")),{click:()=>{this.disableButtons(),[()=>new nr("How many players?",[{label:"7 civilizations",value:7},{label:"6 civilizations",value:6},{label:"5 civilizations",value:5},{label:"4 civilizations",value:4},{label:"3 civilizations",value:3}],e=>transport.send("setOption",{name:"players",value:e})).display()].reduce((t,e)=>t.then(()=>e()),Promise.resolve()).then(()=>{this.remove(),transport.send("start")})}}),L(c("button",g("Quit")),{click:()=>{this.remove(),transport.send("quit")}})))}disableButtons(){this.element().querySelectorAll("button").forEach(t=>t.setAttribute("disabled",""))}remove(){this.element().classList.remove("active"),setTimeout(()=>{this.element().remove()},2e3)}},or=Ei;var j,F,Ee,He,q,Ti=class{constructor(t,e,i,...r){p(this,j,void 0);p(this,F,void 0);p(this,Ee,void 0);p(this,He,void 0);p(this,q,void 0);h(this,F,t),h(this,q,e),h(this,He,i),h(this,Ee,r),h(this,j,o(this,F).getContext("2d")),o(this,F).addEventListener("click",n=>{let s=n.offsetX-o(this,F).offsetLeft,l=n.offsetY-o(this,F).offsetTop,d=Math.ceil(s/o(this,F).offsetWidth*o(this,q).width()),u=Math.ceil(l/o(this,F).offsetHeight*o(this,q).height());o(this,He).setCenter(d,u),this.update()})}update(){let t=o(this,Ee)[0].canvas().height*(190/o(this,Ee)[0].canvas().width);o(this,F).height=t,o(this,j).clearRect(0,0,190,t),o(this,Ee).forEach(r=>o(this,j).drawImage(r.canvas(),0,0,190,t));let[e,i]=o(this,He).visibleRange();o(this,j).lineWidth=1,o(this,j).strokeStyle="#fff",o(this,j).fillStyle="rgba(255, 255, 255, .2)",o(this,j).rect(Math.floor(190/o(this,q).width()*e.x),Math.floor(t/o(this,q).height()*e.y),Math.floor(190/o(this,q).width()*(i.x-e.x)),Math.floor(t/o(this,q).height()*(i.y-e.y))),o(this,j).stroke(),o(this,j).fill()}};j=new WeakMap,F=new WeakMap,Ee=new WeakMap,He=new WeakMap,q=new WeakMap;var sr=Ti;var st,_e,Ci=class{constructor(t=document.body){p(this,st,void 0);p(this,_e,[]);h(this,st,t)}receive(t){o(this,_e).push(t),this.check()}check(){let t=document.querySelector(".notificationWindow");if(!o(this,_e).length||t)return;let e=o(this,_e).shift();this.publish(e)}publish(t){var i;new pt((i=t.title)!=null?i:"Notification",t.message,{parent:o(this,st)}).element().addEventListener("close",()=>this.check())}};st=new WeakMap,_e=new WeakMap;var ar=Ci;var at,Li=class extends N{constructor(e,i){super(e);p(this,at,void 0);h(this,at,i)}build(){this.empty();let{civilization:e,treasury:i,research:r,cities:n}=o(this,at),[s,l]=n.reduce(([u,f],m)=>m.yields.reduce(([b,y],M)=>M._==="Research"?[b,y+M.value]:le.Gold.includes(M._)?[b+M.value,y]:[b,y],[u,f]),[0,0]),d=Math.ceil((r.cost.value-r.progress.value)/l);this.element().append(c("h3",g(`${e.leader.name} of the ${e._} empire`)),c("p",c("strong",g("Researching")),c("br"),g(r.researching?`${r.researching._} ${r.progress.value} / ${r.cost.value} (${d} turn${d===1?"":"s"})`:"Nothing")),c("p",c("strong",g("Treasury")),c("br"),g(`${i.value} (${s} / turn)`)))}};at=new WeakMap;var lr=Li;var C,Ii=class extends N{constructor(e,i){super(e);p(this,C,void 0);h(this,C,i),this.build()}build(){var e,i;this.empty(),o(this,C)!==null&&this.element().append(c("p",g(`${o(this,C)._} (${o(this,C).tile.x}, ${o(this,C).tile.y})`)),c("p",g((i=(e=o(this,C).city)==null?void 0:e.name)!=null?i:"NONE")),c("p",g(`${Number.isInteger(o(this,C).moves.value)?o(this,C).moves.value:o(this,C).moves.value.toFixed(2)} / ${o(this,C).movement.value} moves`)),c("p",g(`A: ${o(this,C).attack.value} / D: ${o(this,C).defence.value} / V: ${o(this,C).visibility.value}`)),c("p",g(`${o(this,C).improvements.map(r=>r._).join(", ")}`)),c("p",g(`${o(this,C).tile.terrain._}${o(this,C).tile.terrain.features?" "+o(this,C).tile.terrain.features.map(r=>r._).join(", "):""}${o(this,C).tile.improvements.length?" ("+o(this,C).tile.improvements.map(r=>r._).join(", ")+")":""}`)),c("p",g(`${o(this,C).tile.units.filter(r=>r!==o(this,C)).map(r=>r._).join(", ")}`)))}};C=new WeakMap;var dr=Ii;var Yr={autoEndOfTurn:!0};try{let a=document.getElementById("notification"),t=document.querySelector("#mainmenu"),e=document.getElementById("actions"),i=document.getElementById("other-actions"),r=document.getElementById("game"),n=document.getElementById("map"),s=n.querySelector("canvas"),l=document.getElementById("gameDetails"),d=document.getElementById("playerDetails"),u=document.getElementById("minimap"),f=document.getElementById("unitInfo"),m=new ar,b=new or(t),y=(E,k,J,ue)=>{let X=new dr(f,E);if(B=E,X.build(),J.setActiveUnit(E),J.render(),J.setVisible(!0),ue.setActiveUnit(E),ue.render(),ue.setVisible(!0),E===null){k.render();return}P=E,J.update([...P!=null&&P.tile?[P.tile]:[],E.tile]),k.isVisible(E.tile.x,E.tile.y)||k.setCenter(E.tile.x,E.tile.y),k.render()},M=[],ce,P=null,B=null;transport.receive("notification",E=>{a.innerHTML=E,ce&&window.clearTimeout(ce),ce=window.setTimeout(()=>{ce=void 0,a.innerText=""},4e3)}),[["chooseCivilization","Choose your civilization"],["chooseLeader","Choose your leader"]].forEach(([E,k])=>transport.receive(E,J=>{let{choices:ue}=dt(J);new te(k,ue.map(({_:X})=>({label:X,value:X})),X=>transport.send(E,X),k,{displayAll:!0})})),transport.receiveOnce("gameData",E=>{try{let k=dt(E),J=new Intl.ListFormat;new pt("Welcome",c("div.welcome",c("p",g(`${k.player.civilization.leader.name}, you have risen to become leader of the ${k.player.civilization._}.`)),c("p",g(`Your people have knowledge of ${J.format(["Irrigation","Mining","Roads",...k.player.research.complete.map(v=>v._)])}`)))),r.classList.add("active"),s.width=s.parentElement.offsetWidth,s.height=s.parentElement.offsetHeight;let ue=2,X=new Tt(k.player.world),lt=[],cr=new rr,T=new tr(X,s,{playerId:k.player.id,scale:ue,tileSize:16},qe,bt,xt,gt,mt,ir,ft,Pe,rt,Ve,gi,mi),ur=T.getLayer(qe),Mt=T.getLayer(Pe),Oe=T.getLayer(rt),Pt=T.getLayer(Ve),Mi=T.getLayer(gi),Ue=T.getLayer(mi);Mt.setVisible(!1);let St=new sr(u,X,T,ur,Pt),Pi=new ui(e,T),pr=new ui(i,T);T.on("focus-changed",()=>St.update()),T.on("activate-unit",v=>y(v,T,Oe,Ue)),cr.on(()=>{Ue.setVisible(!Ue.isVisible()),T.build(M.splice(0)),T.render()}),window.addEventListener("resize",()=>{s.width=s.parentElement.offsetWidth,s.height=s.parentElement.offsetHeight});let Si=1,kt=!1,At=v=>{let x=kt?[]:null,w=dt(v,x);x&&((S=>{for(let De=0,vr=Math.ceil(S.length/1e3);De<vr;De++)setTimeout(()=>S.slice(De*1e3,(De+1)*1e3-1).forEach(br=>delete v.objects[br]),(De+1)*200)})(x),kt=!1),document.dispatchEvent(new CustomEvent("dataupdated",{detail:{data:w}})),Si!==w.turn.value&&(kt=!0,Si=w.turn.value),Pi.build(w.player.mandatoryActions),pr.build(w.player.actions.filter(S=>["AdjustTradeRates","Revolution"].includes(S._))),r.append(Pi.element()),X.setTiles(w.player.world.tiles),new er(l,w.turn,w.year).build(),new lr(d,w.player).build(),lt=w.player.actions.filter(S=>S._==="ActiveUnit");let[A]=lt.sort(({value:S},{value:Z})=>Z===P?1:S===P?-1:(T.isVisible(Z.tile.x,Z.tile.y)?1:0)-(T.isVisible(S.tile.x,S.tile.y)?1:0));if(P!==(A==null?void 0:A.value)&&(P=null),y(P!=null&&P.active?P:A?A.value:null,T,Oe,Ue),T.build(M.splice(0)),T.render(),St.update(),Yr.autoEndOfTurn&&w.player.mandatoryActions.length===1&&w.player.mandatoryActions.every(S=>S._==="EndTurn")){transport.send("action",{name:"EndTurn"});return}};At(E),transport.receive("gameData",v=>{console.log("gameData called again"),At(v)});let hr=v=>v.replace(/]/g,"").split(/[.[]/),ki=(v,x)=>{let w=hr(x),I=w.pop();return[w.reduce((A,S)=>!A||!(S in A)?null:A[S],v),I]},mr=(v,x,w)=>{let[I,D]=ki(v,x);if(!I||!D){console.warn(`unable to set ${x} of ${v} (${D})`);return}I[D]=w},fr=(v,x)=>{let[w,I]=ki(v,x);if(!w||!I){console.warn(`unable to set ${x} of ${v} (${I})`);return}delete w[I]};transport.receive("gameDataPatch",v=>{v.forEach(x=>Object.entries(x).forEach(([w,{type:I,index:D,value:A}])=>{if(I==="add"||I==="update"){if(!A.hierarchy){console.error("No hierarchy"),console.error(A);return}D?mr(E.objects[w],D,A.hierarchy):E.objects[w]=A.hierarchy,document.dispatchEvent(new CustomEvent("patchdatareceived",{detail:{value:A}})),Object.entries(A.objects).forEach(([S,Z])=>{E.objects[S]=Z,Z._==="PlayerTile"&&M.push(Z)})}if(I==="remove"){if(D){fr(E.objects[w],D);return}delete E.objects[w]}})),At(E)}),transport.receive("gameNotification",v=>m.receive(v));let Ai={" ":["NoOrders"],b:["FoundCity"],D:["Disband"],f:["Fortify","BuildFortress"],i:["BuildIrrigation","ClearForest","ClearSwamp","ClearJungle"],m:["BuildMine","PlantForest"],P:["Pillage"],r:["BuildRoad","BuildRailroad"],s:["Sleep"],u:["Unload"],w:["Wait"]},Ht={ArrowUp:"n",PageUp:"ne",ArrowRight:"e",PageDown:"se",ArrowDown:"s",End:"sw",ArrowLeft:"w",Home:"nw"},gr={8:"n",9:"ne",6:"e",3:"se",2:"s",1:"sw",4:"w",7:"nw"},Vr={[KeyboardEvent.DOM_KEY_LOCATION_STANDARD]:Ht,[KeyboardEvent.DOM_KEY_LOCATION_NUMPAD]:gr},Hi="";document.addEventListener("keydown",v=>{if(B){if(v.key in Ai){let x=[...Ai[v.key]];for(;x.length;){let w=x.shift(),[I]=B.actions.filter(D=>D._===w);if(I){transport.send("action",{name:"ActiveUnit",id:B.id,unitAction:I._,target:I.to.id}),v.stopPropagation(),v.preventDefault();return}}}if(v.key in Ht){let[x]=B.actionsForNeighbours[Ht[v.key]];if(x){transport.send("action",{name:"ActiveUnit",id:B.id,unitAction:x._,target:x.to.id}),v.stopPropagation(),v.preventDefault();return}}}if(v.key==="Escape"&&document.activeElement!==null){document.activeElement.blur();return}if(v.key==="Enter"&&k.player.mandatoryActions.some(x=>x._==="EndOfTurn")){transport.send("action",{name:"EndTurn"}),v.stopPropagation(),v.preventDefault();return}if(v.key==="Tab"){let x=e.querySelector("div.action:first-child button");if(x!==null){x.focus(),v.preventDefault(),v.stopPropagation();return}}if(v.key==="c"&&B){T.setCenter(B.tile.x,B.tile.y),T.render(),St.update();return}if(v.key==="w"&&B&&lt.length>1){let x=lt.map(D=>D.value),w=x.indexOf(B),I=x[w===x.length-1?0:w+1];y(I,T,Oe,Ue)}if(v.key==="t"){Oe.setVisible(!Oe.isVisible()),Pt.setVisible(!Pt.isVisible()),Mi.setVisible(!Mi.isVisible()),T.render();return}if(v.key==="y"){Mt.setVisible(!Mt.isVisible()),T.render();return}if(Hi==="%"&&v.key==="^"){transport.send("cheat",{name:"RevealMap"});return}Hi=v.key})}catch(k){console.error(k)}})}catch(a){console.error(a)}})();
//# sourceMappingURL=renderer.js.map
